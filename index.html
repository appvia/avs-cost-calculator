<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VMware to Azure VMware Solution Migration ROI Calculator</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #0078d4, #106ebe);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .header h1 {
            margin: 0;
            font-size: 2.5em;
            font-weight: 300;
        }
        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }
        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            background: #f8f9fa;
            border: none;
            transition: all 0.3s;
            font-size: 16px;
            font-weight: 500;
        }
        .tab.active {
            background: white;
            color: #0078d4;
            border-bottom: 3px solid #0078d4;
        }
        .tab:hover {
            background: #e9ecef;
        }
        .tab-content {
            display: none;
            padding: 30px;
        }
        .tab-content.active {
            display: block;
        }
        .section {
            margin-bottom: 40px;
        }
        .section h2 {
            color: #0078d4;
            border-bottom: 2px solid #0078d4;
            padding-bottom: 10px;
            margin-bottom: 20px;
            font-size: 1.5em;
        }
        .section h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.2em;
        }
        .input-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        .input-field {
            display: flex;
            flex-direction: column;
        }
        .input-field label {
            margin-bottom: 5px;
            font-weight: 500;
            color: #333;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .input-field input, .input-field select {
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 5px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        .input-field input:focus, .input-field select:focus {
            outline: none;
            border-color: #0078d4;
        }
        .calculate-btn {
            background: linear-gradient(135deg, #0078d4, #106ebe);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 18px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            display: block;
            margin: 30px auto;
            min-width: 200px;
        }
        .calculate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,120,212,0.3);
        }
        .results {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 10px;
            margin-top: 30px;
        }
        .results h2 {
            color: #0078d4;
            margin-bottom: 20px;
            text-align: center;
        }
        .metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: white;
            margin-bottom: 10px;
            border-radius: 5px;
            border-left: 4px solid #0078d4;
        }
        .metric-label {
            font-weight: 500;
            color: #333;
        }
        .metric-value {
            font-size: 1.2em;
            font-weight: bold;
            color: #0078d4;
        }
        .positive {
            color: #28a745;
        }
        .funding {
            color: #17a2b8;
            font-weight: bold;
        }
        .negative {
            color: #dc3545;
        }
        .breakdown {
            margin-top: 30px;
        }
        .breakdown-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        .breakdown-table th, .breakdown-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }
        .breakdown-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }
        .breakdown-table tr:hover {
            background: #f8f9fa;
        }
        
        .year-details {
            display: none;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-top: none;
            padding: 15px;
            margin: 0;
        }
        
        .year-details.show {
            display: block;
        }
        
        .year-details h5 {
            color: #0078d4;
            margin: 0 0 10px 0;
            font-size: 16px;
        }
        
        .calculation-detail {
            margin: 5px 0;
            padding: 3px 0;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }
        
        .calculation-detail.formula {
            background: #e3f2fd;
            padding: 5px;
            border-radius: 3px;
            font-weight: bold;
        }
        
        .calculation-detail.result {
            background: #d4edda;
            padding: 5px;
            border-radius: 3px;
            font-weight: bold;
            color: #155724;
        }
        
        .expand-button {
            background: none;
            border: none;
            color: #0078d4;
            cursor: pointer;
            font-size: 12px;
            padding: 2px 5px;
            border-radius: 3px;
            margin-left: 10px;
        }
        
        .expand-button:hover {
            background: #e3f2fd;
        }
        .formula-box {
            background: #e3f2fd;
            border: 1px solid #0078d4;
            border-radius: 5px;
            padding: 20px;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
        }
        .formula-box h4 {
            margin-top: 0;
            color: #0078d4;
        }

        /* Tooltip styles */
        .info-icon {
            position: relative;
            display: inline-block;
            cursor: help;
            width: 16px;
            height: 16px;
            background: #0078d4;
            color: white;
            border-radius: 50%;
            text-align: center;
            font-size: 12px;
            line-height: 16px;
            font-weight: bold;
        }
        
        .info-icon:hover .tooltip {
            visibility: visible;
            opacity: 1;
        }
        
        .tooltip {
            visibility: hidden;
            width: 250px;
            background-color: #333;
            color: #fff;
            text-align: left;
            border-radius: 6px;
            padding: 10px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -125px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
            font-weight: normal;
            line-height: 1.4;
        }
        
        .tooltip::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #333 transparent transparent transparent;
        }

        .modernisation-summary {
            background: #e8f5e8;
            border: 1px solid #28a745;
            border-radius: 5px;
            padding: 15px;
            margin: 20px 0;
        }
        
        .modernisation-summary h4 {
            color: #28a745;
            margin-top: 0;
        }

        /* Radio button styling */
        .input-field label input[type="radio"] {
            margin-right: 8px;
            margin-left: 0;
            transform: scale(1.2);
        }

        .refresh-summary {
            background: #e3f2fd;
            border: 1px solid #0078d4;
            border-radius: 5px;
            padding: 15px;
            margin: 20px 0;
        }
        
        .refresh-summary h4 {
            color: #0078d4;
            margin-top: 0;
        }

        /* Calculation details styling */
        .calculation-section {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .calculation-section h4 {
            color: #0078d4;
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 1.1em;
        }
        
        .calculation-step {
            margin: 8px 0;
            padding: 5px 0;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        
        .calculation-result {
            font-weight: bold;
            color: #28a745;
            background: #d4edda;
            padding: 8px;
            border-radius: 4px;
            margin: 10px 0;
        }
        
        .calculation-formula {
            background: #e3f2fd;
            padding: 8px;
            border-radius: 4px;
            margin: 8px 0;
            font-style: italic;
        }


    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>VMware to Azure VMware Solution Migration ROI Calculator</h1>
            <p>Comprehensive Total Cost of Ownership and Return on Investment Analysis</p>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="showTab('current')">Current Environment</button>
            <button class="tab" onclick="showTab('azure')">Azure VMware Solution</button>
            <button class="tab" onclick="showTab('modernisation')">Modernisation</button>
            <button class="tab" onclick="showTab('migration')">Migration Costs</button>
            <button class="tab" onclick="showTab('scenario')">Scenario Planning</button>
            <button class="tab" onclick="showTab('documentation')">Documentation</button>
            <button class="tab" onclick="showTab('results')">ROI Analysis</button>
        </div>
        
        <div id="current" class="tab-content active">
            <div class="section">
                <h2>Current On-Premises VMware Environment</h2>
                
                <div class="section">
                    <h3>Cost Calculation Method</h3>
                    <div class="input-group">
                        <div class="input-field">
                            <label>
                                <input type="radio" name="cost_method" value="fixed" onchange="toggleCostMethod()" checked> 
                                Fixed Annual Cost
                                <span class="info-icon">i
                                    <span class="tooltip">Use a single total annual cost figure for your current on-premises environment. Simpler but less detailed analysis.</span>
                                </span>
                            </label>
                        </div>
                        <div class="input-field">
                            <label>
                                <input type="radio" name="cost_method" value="breakdown" onchange="toggleCostMethod()"> 
                                Detailed Cost Breakdown
                                <span class="info-icon">i
                                    <span class="tooltip">Break down costs into detailed categories for more accurate analysis and better understanding of cost drivers.</span>
                                </span>
                            </label>
                        </div>
                    </div>
                </div>

                <div id="fixed-cost-section" class="section">
                    <h3>Fixed Annual Cost</h3>
                    <div class="input-group">
                        <div class="input-field">
                            <label>Annual Hardware Costs (Â£)
                                <span class="info-icon">i
                                    <span class="tooltip">Total annual hardware costs including support, maintenance, facilities, power, and operational expenses. DO NOT include VMware licensing (handled separately).</span>
                                </span>
                            </label>
                            <input type="number" id="fixed_annual_cost" value="200000" step="5000">
                        </div>
                        <div class="input-field">
                            <!-- Empty for grid alignment -->
                        </div>
                    </div>
                </div>

                <div id="breakdown-cost-section" class="section" style="display: none;">
                    <div class="section">
                        <h3>Infrastructure Costs (Annual)</h3>
                        <div class="input-group">
                            <div class="input-field">
                                <label>Hardware Support & Maintenance (Â£)
                                    <span class="info-icon">i
                                        <span class="tooltip">ONGOING annual costs that stop when you migrate: hardware support contracts, maintenance, warranty, and lease payments. DO NOT include depreciation of already-purchased equipment - that's a sunk cost.</span>
                                    </span>
                                </label>
                                <input type="number" id="hardware_cost" value="30000" step="1000">
                            </div>
                            <div class="input-field">
                                <label>VMware Licensing (Â£)
                                    <span class="info-icon">i
                                        <span class="tooltip">Annual VMware licensing costs including vSphere, vCenter, vSAN, NSX, and any other VMware products. Include support and subscription costs.</span>
                                    </span>
                                </label>
                                <input type="number" id="vmware_licensing" value="64000" step="1000">
                            </div>
                            <div class="input-field">
                                <label>Storage Support & Maintenance (Â£)
                                    <span class="info-icon">i
                                        <span class="tooltip">ONGOING costs only: SAN/NAS support contracts, maintenance agreements. DO NOT include depreciation of purchased storage equipment.</span>
                                    </span>
                                </label>
                                <input type="number" id="storage_hardware" value="12000" step="1000">
                            </div>
                            <div class="input-field">
                                <label>Network Equipment Support (Â£)
                                    <span class="info-icon">i
                                        <span class="tooltip">ONGOING costs only: support contracts for switches, routers, firewalls. Most network equipment will remain for cloud connectivity.</span>
                                    </span>
                                </label>
                                <input type="number" id="network_equipment" value="8000" step="1000">
                            </div>
                            <div class="input-field">
                                <label>Backup Software & Support (Â£)
                                    <span class="info-icon">i
                                        <span class="tooltip">ONGOING costs only: backup software licenses, support contracts, offsite storage fees. DO NOT include depreciation of purchased backup appliances.</span>
                                    </span>
                                </label>
                                <input type="number" id="backup_hardware" value="8000" step="1000">
                            </div>
                            <div class="input-field">
                                <label>Support Contracts (Â£)
                                    <span class="info-icon">i
                                        <span class="tooltip">Hardware support contracts, software maintenance, and third-party support services for your infrastructure.</span>
                                    </span>
                                </label>
                                <input type="number" id="support_contracts" value="48000" step="1000">
                            </div>
                        </div>
                    </div>
                    
                    <div class="section">
                        <h3>Facilities & Operations (Annual)</h3>
                        <div class="input-group">
                            <div class="input-field">
                                <label>Data Centre Space (Â£)
                                    <span class="info-icon">i
                                        <span class="tooltip">Rack space rental, colocation fees, or allocated data centre space costs including security and access.</span>
                                    </span>
                                </label>
                                <input type="number" id="datacenter_space" value="32000" step="1000">
                            </div>
                            <div class="input-field">
                                <label>Power & Cooling (Â£)
                                    <span class="info-icon">i
                                        <span class="tooltip">Electricity costs for servers and infrastructure, UPS systems, cooling/HVAC, and power distribution equipment.</span>
                                    </span>
                                </label>
                                <input type="number" id="power_cooling" value="28000" step="1000">
                            </div>
                            <div class="input-field">
                                <label>Staff Costs (FTE x Salary) (Â£)
                                    <span class="info-icon">i
                                        <span class="tooltip">Total annual cost of IT staff managing VMware infrastructure including salaries, benefits, training, and contractor costs.</span>
                                    </span>
                                </label>
                                <input type="number" id="staff_costs" value="160000" step="5000">
                            </div>
                            <div class="input-field">
                                <label>Internet/Connectivity (Â£)
                                    <span class="info-icon">i
                                        <span class="tooltip">ISP costs, dedicated lines, MPLS circuits, and other network connectivity charges.</span>
                                    </span>
                                </label>
                                <input type="number" id="connectivity" value="12000" step="1000">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="section">
                    <h3>VMware License Renewal</h3>
                    <div class="input-group">
                        <div class="input-field">
                            <label>Current VMware License Cost (Annual) (Â£)
                                <span class="info-icon">i
                                    <span class="tooltip">Current annual VMware licensing cost. This should match the VMware Licensing field above but is separated here for renewal planning.</span>
                                </span>
                            </label>
                            <input type="number" id="current_vmware_cost" value="64000" step="1000">
                        </div>
                        <div class="input-field">
                            <label>License Renewal Date
                                <span class="info-icon">i
                                    <span class="tooltip">When does your current VMware license agreement expire and need renewal? This is critical for timing cost avoidance.</span>
                                </span>
                            </label>
                            <input type="date" id="license_renewal_date" value="2025-12-31">
                        </div>
                        <div class="input-field">
                            <label>Expected New License Cost (Annual) (Â£)
                                <span class="info-icon">i
                                    <span class="tooltip">Expected annual cost if you renew VMware licenses (e.g., under Broadcom's new pricing). Enter 0 if no increase expected.</span>
                                </span>
                            </label>
                            <input type="number" id="new_vmware_cost" value="150000" step="5000">
                        </div>
                        <div class="input-field">
                            <label>License Commitment Period (Years)
                                <span class="info-icon">i
                                    <span class="tooltip">How many years will you be locked into paying if you renew? This is critical - you must pay for the full commitment period even if you migrate partway through. 1-3 years typical.</span>
                                </span>
                            </label>
                            <input type="number" id="license_commitment_years" value="1" step="1" min="1" max="5">
                        </div>
                    </div>
                </div>
                
                <div class="refresh-summary">
                    <h4>ðŸ’¡ License Renewal Strategy</h4>
                    <p>The calculator considers the timing of your VMware license renewal vs. migration completion:</p>
                    <ul style="margin: 10px 0; padding-left: 20px;">
                        <li><strong>Migrate before renewal:</strong> Avoid price increases entirely</li>
                        <li><strong>Migrate after renewal:</strong> Pay increased costs until migration completes</li>
                        <li><strong>Migration during renewal year:</strong> Costs are prorated based on timing</li>
                    </ul>
                    <p><em>This realistic approach shows the true financial impact of migration timing vs. license renewal dates.</em></p>
                </div>
                
                <div class="section">
                    <h3>Hardware Refresh Planning</h3>
                    <div class="input-group">
                        <div class="input-field">
                            <label>Hardware Purchase Date
                                <span class="info-icon">i
                                    <span class="tooltip">When was the majority of your current hardware purchased? This affects refresh timing and remaining value.</span>
                                </span>
                            </label>
                            <input type="date" id="hardware_purchase_date" value="2020-01-01">
                        </div>
                        <div class="input-field">
                            <label>Hardware Refresh Cycle (Years)
                                <span class="info-icon">i
                                    <span class="tooltip">How often do you typically refresh your hardware? Usually 3-5 years for servers, 5-7 years for storage/network equipment.</span>
                                </span>
                            </label>
                            <input type="number" id="refresh_cycle_years" value="4" step="1" min="1" max="10">
                        </div>
                        <div class="input-field">
                            <label>Refresh Cost Multiplier
                                <span class="info-icon">i
                                    <span class="tooltip">Hardware replacement cost as a multiple of current annual hardware costs. 1.0 = same cost, 1.2 = 20% increase for newer technology.</span>
                                </span>
                            </label>
                            <input type="number" id="refresh_cost_multiplier" value="1.15" step="0.05" min="0.5" max="3.0">
                        </div>
                        <div class="input-field">
                            <label>Percentage to Refresh (%)
                                <span class="info-icon">i
                                    <span class="tooltip">What percentage of your infrastructure will need refreshing? 100% for full refresh, or lower if some equipment is newer.</span>
                                </span>
                            </label>
                            <input type="number" id="refresh_percentage" value="85" step="5" min="0" max="100">
                        </div>
                        <div class="input-field">
                            <label>Hardware End of Support Date
                                <span class="info-icon">i
                                    <span class="tooltip">When does hardware vendor support end? After this date, you may not receive security updates, patches, or technical support from the vendor.</span>
                                </span>
                            </label>
                            <input type="date" id="hardware_end_of_support" value="2025-01-01">
                        </div>
                        <div class="input-field">
                            <label>Hardware End of Life Date
                                <span class="info-icon">i
                                    <span class="tooltip">When does the hardware reach end of life? After this date, the hardware is no longer supported by the vendor and may pose security or compliance risks.</span>
                                </span>
                            </label>
                            <input type="date" id="hardware_end_of_life" value="2026-01-01">
                        </div>
                    </div>
                </div>

                <div id="refresh-summary" class="refresh-summary">
                    <h4>Hardware Refresh Schedule</h4>
                    <p id="refresh-schedule-text">Configure hardware refresh settings above to see the schedule.</p>
                </div>
                
                <div class="section">
                    <h3>Environment Details</h3>
                    <div class="input-group">
                        <div class="input-field">
                            <label>Number of VMs
                                <span class="info-icon">i
                                    <span class="tooltip">Total number of virtual machines currently running in your VMware environment.</span>
                                </span>
                            </label>
                            <input type="number" id="vm_count" value="200" step="10">
                        </div>
                        <div class="input-field">
                            <label>Total vCPUs
                                <span class="info-icon">i
                                    <span class="tooltip">Total number of virtual CPU cores allocated across all VMs.</span>
                                </span>
                            </label>
                            <input type="number" id="total_vcpus" value="800" step="50">
                        </div>
                        <div class="input-field">
                            <label>Total RAM (GB)
                                <span class="info-icon">i
                                    <span class="tooltip">Total amount of RAM allocated to all virtual machines in gigabytes.</span>
                                </span>
                            </label>
                            <input type="number" id="total_ram" value="3200" step="100">
                        </div>
                        <div class="input-field">
                            <label>Total Storage (TB)
                                <span class="info-icon">i
                                    <span class="tooltip">Total storage capacity consumed by all VMs including OS, applications, and data in terabytes.</span>
                                </span>
                            </label>
                            <input type="number" id="total_storage" value="50" step="5">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="azure" class="tab-content">
            <div class="section">
                <h2>Azure VMware Solution Costs</h2>
                
                <div class="section">
                    <h3>AVS Configuration</h3>
                    <div class="input-group">
                        <div class="input-field">
                            <label>Number of AVS Clusters
                                <span class="info-icon">i
                                    <span class="tooltip">Number of separate AVS clusters needed. Multiple clusters may be required for large environments, different workload types (prod/dev/test), or geographical distribution.</span>
                                </span>
                            </label>
                            <input type="number" id="avs_clusters" value="1" step="1" min="1" max="10">
                        </div>
                        <div class="input-field">
                            <label>AVS Node Type
                                <span class="info-icon">i
                                    <span class="tooltip">Choose the Azure VMware Solution node type based on performance requirements. AV36 is standard, AV36P has more RAM, AV52 is high-performance with more storage, AV64 is CPU-optimized.</span>
                                </span>
                            </label>
                            <select id="avs_node_type">
                                <option value="AV36">AV36 (36 cores, 576GB RAM, 15.36TB vSAN)</option>
                                <option value="AV36P">AV36P (36 cores, 768GB RAM, 15.36TB vSAN)</option>
                                <option value="AV52">AV52 (52 cores, 1536GB RAM, 30.72TB vSAN)</option>
                                <option value="AV64">AV64 (64 cores, 512GB RAM, 15.36TB vSAN)</option>
                            </select>
                        </div>
                        <div class="input-field">
                            <label>Nodes Per Cluster
                                <span class="info-icon">i
                                    <span class="tooltip">Number of nodes in each cluster. Minimum 3 nodes required per AVS cluster. Size based on your CPU, RAM, and storage requirements with 25% headroom recommended.</span>
                                </span>
                            </label>
                            <input type="number" id="avs_nodes" value="6" step="1" min="3">
                        </div>
                        <div class="input-field">
                            <label>Reserved Instance Term
                                <span class="info-icon">i
                                    <span class="tooltip">Reserved instances provide significant discounts. 1-year offers ~20% savings, 3-year offers ~40% savings versus pay-as-you-go.</span>
                                </span>
                            </label>
                            <select id="reserved_term">
                                <option value="payg">Pay-as-you-go</option>
                                <option value="1year">1 Year Reserved</option>
                                <option value="3year">3 Year Reserved</option>
                            </select>
                        </div>
                        <div class="input-field">
                            <label>Azure Hybrid Benefit
                                <span class="info-icon">i
                                    <span class="tooltip">Use existing Windows Server and SQL Server licenses in Azure for additional savings. Requires Software Assurance.</span>
                                </span>
                            </label>
                            <select id="hybrid_benefit">
                                <option value="no">No</option>
                                <option value="yes">Yes</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="section">
                    <h3>Additional Azure Services (Monthly)</h3>
                    <div class="input-group">
                        <div class="input-field">
                            <label>ExpressRoute (Â£)
                                <span class="info-icon">i
                                    <span class="tooltip">Dedicated private network connection to Azure. Required for production AVS deployments. Cost depends on bandwidth (1Gbps, 10Gbps, etc.)</span>
                                </span>
                            </label>
                            <input type="number" id="expressroute" value="400" step="50">
                        </div>
                        <div class="input-field">
                            <label>Azure Backup (Â£)
                                <span class="info-icon">i
                                    <span class="tooltip">Azure Backup service costs based on protected data volume and retention requirements.</span>
                                </span>
                            </label>
                            <input type="number" id="azure_backup" value="640" step="50">
                        </div>
                        <div class="input-field">
                            <label>Data Transfer (Â£)
                                <span class="info-icon">i
                                    <span class="tooltip">Outbound data transfer charges for internet traffic, VPN connections, and cross-region replication.</span>
                                </span>
                            </label>
                            <input type="number" id="data_transfer" value="240" step="50">
                        </div>
                        <div class="input-field">
                            <label>Monitoring & Management (Â£)
                                <span class="info-icon">i
                                    <span class="tooltip">Azure Monitor, Log Analytics, Security Center, and other management tool costs.</span>
                                </span>
                            </label>
                            <input type="number" id="monitoring" value="320" step="50">
                        </div>
                        <div class="input-field">
                            <label>Additional Storage (Â£)
                                <span class="info-icon">i
                                    <span class="tooltip">Extra storage beyond what's included with AVS nodes, such as Azure NetApp Files or additional vSAN storage.</span>
                                </span>
                            </label>
                            <input type="number" id="additional_storage" value="480" step="50">
                        </div>
                        <div class="input-field">
                            <label>Security Services (Â£)
                                <span class="info-icon">i
                                    <span class="tooltip">Azure Security Center, Sentinel, Key Vault, and other security services.</span>
                                </span>
                            </label>
                            <input type="number" id="security_services" value="240" step="50">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="modernisation" class="tab-content">
            <div class="section">
                <h2>Cloud Modernisation Opportunities</h2>
                <p>Identify workloads that can be modernised to native Azure services instead of running on AVS, reducing licensing and infrastructure costs.</p>
                
                <div class="section">
                    <h3>Application Modernisation</h3>
                    <div class="input-group">
                        <div class="input-field">
                            <label>VMs Moving to Azure VMs (%)
                                <span class="info-icon">i
                                    <span class="tooltip">Percentage of current VMs that can move to native Azure VMs instead of AVS. These will use Azure compute pricing instead of VMware licensing.</span>
                                </span>
                            </label>
                            <input type="number" id="vms_to_azure" value="0" step="5" min="0" max="100">
                        </div>
                        <div class="input-field">
                            <label>Applications to PaaS (Count)
                                <span class="info-icon">i
                                    <span class="tooltip">Number of applications that can move to Platform-as-a-Service (App Service, Functions, etc.) eliminating the need for VM infrastructure.</span>
                                </span>
                            </label>
                            <input type="number" id="apps_to_paas" value="0" step="1" min="0">
                        </div>
                        <div class="input-field">
                            <label>Databases to Managed Services (Count)
                                <span class="info-icon">i
                                    <span class="tooltip">Number of database VMs moving to Azure SQL Database, MySQL, PostgreSQL, or Cosmos DB managed services.</span>
                                </span>
                            </label>
                            <input type="number" id="databases_to_managed" value="0" step="1" min="0">
                        </div>
                        <div class="input-field">
                            <label>File Servers to Azure Files (Count)
                                <span class="info-icon">i
                                    <span class="tooltip">Number of file server VMs that can be replaced with Azure Files or Azure NetApp Files.</span>
                                </span>
                            </label>
                            <input type="number" id="fileservers_to_azure" value="0" step="1" min="0">
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h3>Modernisation Impact</h3>
                    <div class="input-group">
                        <div class="input-field">
                            <label>AVS Node Reduction (Count)
                                <span class="info-icon">i
                                    <span class="tooltip">Number of AVS nodes that can be eliminated through modernisation efforts. Each node saves significant licensing and infrastructure costs.</span>
                                </span>
                            </label>
                            <input type="number" id="nodes_saved" value="0" step="1" min="0">
                        </div>
                        <div class="input-field">
                            <label>VMware License Reduction (%)
                                <span class="info-icon">i
                                    <span class="tooltip">Percentage reduction in VMware licensing costs due to workloads moving to native Azure services.</span>
                                </span>
                            </label>
                            <input type="number" id="license_reduction" value="0" step="5" min="0" max="100">
                        </div>
                        <div class="input-field">
                            <label>Modernisation Timeline (Months)
                                <span class="info-icon">i
                                    <span class="tooltip">Time to complete modernisation efforts after initial migration. Savings will begin after this period.</span>
                                </span>
                            </label>
                            <input type="number" id="modernisation_timeline" value="12" step="1" min="0" max="36">
                        </div>
                        <div class="input-field">
                            <label>Modernisation Investment (Â£)
                                <span class="info-icon">i
                                    <span class="tooltip">One-time cost for application refactoring, data migration, training, and professional services for modernisation.</span>
                                </span>
                            </label>
                            <input type="number" id="modernisation_investment" value="0" step="5000">
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h3>Native Azure Service Costs (Monthly)</h3>
                    <div class="input-group">
                        <div class="input-field">
                            <label>Azure VMs Cost (Â£)
                                <span class="info-icon">i
                                    <span class="tooltip">Estimated monthly cost for VMs moving to native Azure compute (without AVS). Use Azure calculator for accurate pricing.</span>
                                </span>
                            </label>
                            <input type="number" id="azure_vms_cost" value="0" step="100">
                        </div>
                        <div class="input-field">
                            <label>PaaS Services Cost (Â£)
                                <span class="info-icon">i
                                    <span class="tooltip">Monthly cost for App Service, Functions, and other PaaS services replacing traditional applications.</span>
                                </span>
                            </label>
                            <input type="number" id="paas_cost" value="0" step="50">
                        </div>
                        <div class="input-field">
                            <label>Managed Database Cost (Â£)
                                <span class="info-icon">i
                                    <span class="tooltip">Monthly cost for Azure SQL Database, MySQL, PostgreSQL, and other managed database services.</span>
                                </span>
                            </label>
                            <input type="number" id="managed_db_cost" value="0" step="50">
                        </div>
                        <div class="input-field">
                            <label>Azure Storage Cost (Â£)
                                <span class="info-icon">i
                                    <span class="tooltip">Monthly cost for Azure Files, Blob Storage, and other storage services replacing file servers.</span>
                                </span>
                            </label>
                            <input type="number" id="azure_storage_cost" value="0" step="25">
                        </div>
                    </div>
                </div>

                <div class="modernisation-summary">
                    <h4>Modernisation Benefits</h4>
                    <p>By modernising applications to native Azure services, you can:</p>
                    <ul>
                        <li>Reduce VMware licensing costs</li>
                        <li>Decrease AVS node requirements</li>
                        <li>Improve scalability and resilience</li>
                        <li>Access cloud-native features and services</li>
                        <li>Reduce operational overhead</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <div id="migration" class="tab-content">
            <div class="section">
                <h2>Migration Investment</h2>
                
                <div class="section">
                    <h3>One-Time Migration Costs</h3>
                    <div class="input-group">
                        <div class="input-field">
                            <label>Assessment & Planning (Â£)
                                <span class="info-icon">i
                                    <span class="tooltip">Cost for migration assessment, planning, and design including discovery tools, workshops, and architecture design.</span>
                                </span>
                            </label>
                            <input type="number" id="assessment" value="20000" step="1000">
                        </div>
                        <div class="input-field">
                            <label>Professional Services (Â£)
                                <span class="info-icon">i
                                    <span class="tooltip">Microsoft or partner professional services for migration execution, testing, and cutover support.</span>
                                </span>
                            </label>
                            <input type="number" id="professional_services" value="64000" step="1000">
                        </div>
                        <div class="input-field">
                            <label>Service Transition Cost (Â£)
                                <span class="info-icon">i
                                    <span class="tooltip">Optional costs for service transition including staff handover, documentation, and operational readiness activities.</span>
                                </span>
                            </label>
                            <input type="number" id="service_transition" value="0" step="1000">
                        </div>
                        <div class="input-field">
                            <label>Contingency (% of above)
                                <span class="info-icon">i
                                    <span class="tooltip">Contingency buffer for unexpected costs, scope changes, or extended timelines. 10-20% is typical.</span>
                                </span>
                            </label>
                            <input type="number" id="contingency" value="10" step="1" min="0" max="50">
                        </div>
                        <div class="input-field">
                            <!-- Empty for grid alignment -->
                        </div>
                    </div>
                </div>
                
                <div class="section">
                    <h3>Cloud Partner Funding & Incentives</h3>
                    <div class="input-group">
                        <div class="input-field">
                            <label>Microsoft Partner Migration Funding (Â£)
                                <span class="info-icon">i
                                    <span class="tooltip">Migration funding provided by Microsoft to qualified partners. Typically Â£10,000-Â£50,000+ depending on migration size and partner level.</span>
                                </span>
                            </label>
                            <input type="number" id="migration_funding" value="25000" step="1000">
                        </div>
                        <div class="input-field">
                            <label>Azure Consumption Credits (Â£)
                                <span class="info-icon">i
                                    <span class="tooltip">Azure credits provided to offset initial consumption costs. Often Â£5,000-Â£25,000 for qualified migrations.</span>
                                </span>
                            </label>
                            <input type="number" id="azure_credits" value="15000" step="1000">
                        </div>
                        <div class="input-field">
                            <label>Additional Partner Incentives (Â£)
                                <span class="info-icon">i
                                    <span class="tooltip">Other partner incentives such as go-to-market funding, marketing co-op, or special migration programs.</span>
                                </span>
                            </label>
                            <input type="number" id="additional_incentives" value="0" step="1000">
                        </div>
                        <div class="input-field">
                            <!-- Empty for grid alignment -->
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h3>Migration Timeline</h3>
                    <div class="input-group">
                        <div class="input-field">
                            <label>Migration Start Date
                                <span class="info-icon">i
                                    <span class="tooltip">When will the migration project actually begin? This affects the timing of cost savings and VMware license renewal interactions.</span>
                                </span>
                            </label>
                            <input type="date" id="migration_start_date" value="">
                        </div>
                        <div class="input-field">
                            <label>Migration Duration (Months)
                                <span class="info-icon">i
                                    <span class="tooltip">Time to complete initial migration to AVS from the start date. Modernisation timeline is configured in the Modernisation tab.</span>
                                </span>
                            </label>
                            <input type="number" id="migration_timeline" value="6" step="1" min="1" max="24">
                        </div>
                    </div>
                </div>

                <div id="migration-timeline-summary" class="refresh-summary">
                    <h4>ðŸ“… Migration Schedule</h4>
                    <p id="migration-schedule-text">Configure migration start date and duration above to see the timeline.</p>
                </div>
            </div>
        </div>

        <div id="scenario" class="tab-content">
            <div class="section">
                <h2>Scenario Planning: Migrate vs. Do Nothing</h2>
                <p>Compare the true business impact of two strategic decisions over the next 5 years. This analysis shows the real cost of inaction versus the investment in cloud migration.</p>
                
                <div class="section">
                    <h3>Analysis Parameters</h3>
                    <div class="input-group">
                        <div class="input-field">
                            <label>Analysis Period (Years)
                                <span class="info-icon">i
                                    <span class="tooltip">Time period for scenario comparison. Typically 5 years to capture full lifecycle costs including hardware refresh.</span>
                                </span>
                            </label>
                            <input type="number" id="scenario_analysis_period" value="5" step="1" min="3" max="10">
                        </div>
                        <div class="input-field">
                            <!-- Empty for grid alignment -->
                        </div>
                    </div>
                </div>

                <button class="calculate-btn" onclick="calculateScenarios()">Calculate Scenario Comparison</button>
                
                <div id="scenario-results" class="results" style="display: none;">
                    <h2>Strategic Scenario Analysis</h2>
                    
                    <div class="section">
                        <h3>Executive Summary</h3>
                        <div class="metric">
                            <span class="metric-label">Recommended Strategy</span>
                            <span class="metric-value" id="recommended-strategy">Calculate scenarios to see recommendation</span>
                        </div>
                        
                        <div class="metric">
                            <span class="metric-label">Cost Difference (5 Years)</span>
                            <span class="metric-value" id="scenario-cost-difference">Â£0</span>
                        </div>
                        
                        <div class="metric">
                            <span class="metric-label">Break-Even Point</span>
                            <span class="metric-value" id="scenario-breakeven">Year 0</span>
                        </div>
                    </div>

                    <div class="breakdown">
                        <h3>Scenario Comparison</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin: 20px 0;">
                            
                            <!-- Scenario A: Do Nothing -->
                            <div style="background: #fff5f5; border: 2px solid #feb2b2; border-radius: 10px; padding: 20px;">
                                <h4 style="color: #c53030; margin-top: 0;">ðŸ“Š Scenario A: Do Nothing (Stay On-Premises)</h4>
                                <div class="metric" style="background: transparent; border: none; padding: 5px 0;">
                                    <span class="metric-label" style="font-size: 14px;">5-Year Total Cost</span>
                                    <span class="metric-value" id="scenario-a-total" style="color: #c53030;">Â£0</span>
                                </div>
                                
                                <h5 style="color: #c53030; margin: 15px 0 10px 0;">Key Assumptions:</h5>
                                <ul style="font-size: 14px; margin: 10px 0; padding-left: 20px;">
                                    <li>Continue current operational costs</li>
                                    <li>Hardware refresh when support ends</li>
                                    <li>VMware license renewal at new pricing</li>
                                    <li>Risk of running unsupported systems</li>
                                </ul>
                                
                                <h5 style="color: #c53030; margin: 15px 0 10px 0;">Major Cost Events:</h5>
                                <div id="scenario-a-events" style="font-size: 14px;">
                                    <!-- Events will be populated by JavaScript -->
                                </div>
                            </div>

                            <!-- Scenario B: Migrate -->
                            <div style="background: #f0fff4; border: 2px solid #9ae6b4; border-radius: 10px; padding: 20px;">
                                <h4 style="color: #2f855a; margin-top: 0;">â˜ï¸ Scenario B: Migrate to Azure VMware Solution</h4>
                                <div class="metric" style="background: transparent; border: none; padding: 5px 0;">
                                    <span class="metric-label" style="font-size: 14px;">5-Year Total Cost</span>
                                    <span class="metric-value" id="scenario-b-total" style="color: #2f855a;">Â£0</span>
                                </div>
                                
                                <h5 style="color: #2f855a; margin: 15px 0 10px 0;">Key Assumptions:</h5>
                                <ul style="font-size: 14px; margin: 10px 0; padding-left: 20px;">
                                    <li>One-time migration investment</li>
                                    <li>Azure VMware Solution ongoing costs</li>
                                    <li>No hardware refresh required</li>
                                    <li>No VMware license renewals</li>
                                    <li>Partner funding reduces investment</li>
                                </ul>
                                
                                <h5 style="color: #2f855a; margin: 15px 0 10px 0;">Major Cost Events:</h5>
                                <div id="scenario-b-events" style="font-size: 14px;">
                                    <!-- Events will be populated by JavaScript -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="breakdown">
                        <h3>Year-by-Year Comparison</h3>
                        <table class="breakdown-table">
                            <thead>
                                <tr>
                                    <th>Year</th>
                                    <th>Do Nothing Costs</th>
                                    <th>Migration Costs</th>
                                    <th>Annual Difference</th>
                                    <th>Cumulative Difference</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="scenario-yearly-breakdown">
                            </tbody>
                        </table>
                    </div>

                    <div class="breakdown">
                        <h3>Risk and Business Impact Analysis</h3>
                        <div id="risk-analysis" style="background: #fffaf0; border: 1px solid #ffa500; border-radius: 5px; padding: 20px; margin: 20px 0;">
                            <h4 style="color: #cc7a00; margin-top: 0;">ðŸš¨ "Do Nothing" Risks and Hidden Costs</h4>
                            <ul style="color: #cc7a00;">
                                <li><strong>Security Risk:</strong> Running on unsupported hardware/software after end-of-support dates</li>
                                <li><strong>Compliance Risk:</strong> Potential regulatory violations with unsupported systems</li>
                                <li><strong>Operational Risk:</strong> No vendor support for critical issues</li>
                                <li><strong>Technology Debt:</strong> Falling further behind on modern capabilities</li>
                                <li><strong>Vendor Lock-in:</strong> Continued dependence on expensive VMware licensing</li>
                                <li><strong>Scalability Constraints:</strong> Physical hardware limitations</li>
                            </ul>
                        </div>

                        <div style="background: #f0fff4; border: 1px solid #28a745; border-radius: 5px; padding: 20px; margin: 20px 0;">
                            <h4 style="color: #155724; margin-top: 0;">âœ… Migration Benefits Beyond Cost Savings</h4>
                            <ul style="color: #155724;">
                                <li><strong>Agility:</strong> Rapid provisioning and scaling of resources</li>
                                <li><strong>Reliability:</strong> Enterprise-grade Azure infrastructure with SLAs</li>
                                <li><strong>Innovation:</strong> Access to Azure native services and AI/ML capabilities</li>
                                <li><strong>Global Reach:</strong> Worldwide Azure regions for expansion</li>
                                <li><strong>Disaster Recovery:</strong> Built-in Azure backup and recovery options</li>
                                <li><strong>Future-Proof:</strong> Microsoft-managed infrastructure and updates</li>
                            </ul>
                        </div>
                    </div>

                    <div class="breakdown">
                        <h3>Decision Framework</h3>
                        <div id="decision-matrix" style="background: #f8f9fa; border-radius: 5px; padding: 20px; margin: 20px 0;">
                            <h4 style="color: #0078d4; margin-top: 0;">Strategic Decision Criteria</h4>
                            <table class="breakdown-table">
                                <thead>
                                    <tr>
                                        <th>Criteria</th>
                                        <th>Do Nothing</th>
                                        <th>Migrate to Azure</th>
                                        <th>Winner</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><strong>5-Year Total Cost</strong></td>
                                        <td id="decision-cost-do-nothing">Â£0</td>
                                        <td id="decision-cost-migrate">Â£0</td>
                                        <td id="decision-cost-winner">-</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Capital Investment Required</strong></td>
                                        <td id="decision-capex-do-nothing">High (Hardware Refresh)</td>
                                        <td id="decision-capex-migrate">Low (Migration Only)</td>
                                        <td style="color: #28a745;">âœ… Migrate</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Risk Profile</strong></td>
                                        <td style="color: #dc3545;">High (EOL/EOS)</td>
                                        <td style="color: #28a745;">Low (Modern Platform)</td>
                                        <td style="color: #28a745;">âœ… Migrate</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Operational Flexibility</strong></td>
                                        <td style="color: #dc3545;">Limited</td>
                                        <td style="color: #28a745;">High</td>
                                        <td style="color: #28a745;">âœ… Migrate</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Future Innovation</strong></td>
                                        <td style="color: #dc3545;">Constrained</td>
                                        <td style="color: #28a745;">Enabled</td>
                                        <td style="color: #28a745;">âœ… Migrate</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="documentation" class="tab-content">
            <div class="section">
                <h2>Calculation Methodology & Documentation</h2>
                <p>This calculator uses established financial analysis methods to evaluate the Total Cost of Ownership (TCO) and Return on Investment (ROI) for migrating from on-premises VMware to Azure VMware Solution.</p>
                
                <div class="section">
                    <h3>Core Financial Formulas</h3>
                    
                    <div class="formula-box">
                        <h4>1. Return on Investment (ROI)</h4>
                        <p><strong>ROI = [(Total Savings - Total Investment) / Total Investment] Ã— 100</strong></p>
                        <p><strong>Where:</strong></p>
                        <ul>
                            <li><strong>Total Savings:</strong> Sum of annual cost savings over the analysis period</li>
                            <li><strong>Total Investment:</strong> Net migration costs after partner funding</li>
                        </ul>
                    </div>

                    <div class="formula-box">
                        <h4>2. Payback Period</h4>
                        <p><strong>Payback Period = Time when Cumulative Savings â‰¥ Total Investment</strong></p>
                        <p>Simple calculation showing when the investment will be recovered through cost savings.</p>
                    </div>

                    <div class="formula-box">
                        <h4>3. Total Cost Savings</h4>
                        <p><strong>Total Savings = Î£(t=1 to n) [Annual Savings in Year t]</strong></p>
                        <p>Sum of all cost savings over the analysis period, accounting for growth and modernisation.</p>
                    </div>

                    <div class="formula-box">
                        <h4>4. Migration Investment with Partner Funding</h4>
                        <p><strong>Gross Investment = (Base Migration Costs Ã— (1 + Contingency%)) + Modernisation Investment</strong></p>
                        <p><strong>Partner Funding = Migration Funding + Azure Credits + Services Funding + Training Funding + Additional Incentives</strong></p>
                        <p><strong>Net Investment = Max(0, Gross Investment - Partner Funding)</strong></p>
                        <p><strong>Where:</strong></p>
                        <ul>
                            <li><strong>Base Migration Costs:</strong> Assessment + Tools + Professional Services + Training + Downtime</li>
                            <li><strong>Partner Funding:</strong> Total funding and incentives from Microsoft and partners</li>
                            <li><strong>Net Investment:</strong> Actual customer investment after applying all funding</li>
                        </ul>
                    </div>
                </div>

                <div class="section">
                    <h3>Cost Calculation Methods</h3>
                    
                    <div class="formula-box">
                        <h4>Method 1: Fixed Annual Cost</h4>
                        <p>Uses a single input for total annual hardware costs.</p>
                        <p><strong>Simple approach</strong> - single annual hardware cost covering all operational expenses. VMware licensing handled separately.</p>
                        <p><strong>On-Premises Annual Cost = Annual Hardware Cost + VMware License Cost</strong></p>
                        <p><strong>Simplified comparison</strong> - all costs remain constant year over year</p>
                    </div>

                    <div class="formula-box">
                        <h4>Method 2: Detailed Cost Breakdown</h4>
                        <p><strong>Focus on ONGOING operational costs</strong> - costs that actually stop when you migrate to cloud.</p>
                        <p><strong>On-Premises Annual Cost = Infrastructure Support + Operations</strong></p>
                        <p><strong>Infrastructure Support:</strong> Hardware Support + VMware Licensing + Storage Support + Network Support + Backup Support + Maintenance Contracts</p>
                        <p><strong>Operations:</strong> Data Centre + Power/Cooling + Staff + Connectivity</p>
                        <p><strong>Support Portion:</strong> Hardware Support + Storage Support + Network Support</p>
                        <p><em>Note: This method excludes hardware depreciation as it represents sunk costs, not ongoing cash flow.</em></p>
                    </div>
                </div>

                <div class="section">
                    <h3>Growth and Timing Calculations</h3>
                    
                    <div class="formula-box">
                        <h4>Calendar Year Analysis Approach</h4>
                        <p><strong>Year Definition:</strong> Each analysis year runs from January 1st to December 31st</p>
                        <p><strong>Analysis Year Numbering:</strong></p>
                        <ul>
                            <li><strong>Year 1:</strong> Current calendar year (January - December)</li>
                            <li><strong>Year 2:</strong> Next calendar year (January - December)</li>
                            <li><strong>Year 3:</strong> Second year from now (January - December)</li>
                            <li>And so on...</li>
                        </ul>
                        <p><strong>Example (if running calculator in 2024):</strong></p>
                        <ul>
                            <li>Year 1 = 2024 (January 1, 2024 - December 31, 2024)</li>
                            <li>Year 2 = 2025 (January 1, 2025 - December 31, 2025)</li>
                            <li>Year 3 = 2026 (January 1, 2026 - December 31, 2026)</li>
                        </ul>
                        <p><strong>VMware License Logic (Including Commitment Periods):</strong></p>
                        <ul>
                            <li><strong>Key Rule:</strong> You pay VMware costs until BOTH conditions are met: Migration complete AND License commitment ends</li>
                            <li><strong>Before license renewal:</strong> Current license costs apply</li>
                            <li><strong>After license renewal:</strong> New (often higher) license costs apply for the full commitment period</li>
                            <li><strong>Migration complete but commitment active:</strong> Still pay full VMware costs</li>
                            <li><strong>Both conditions met:</strong> Zero VMware license costs</li>
                        </ul>
                        <p><strong>Real Example:</strong></p>
                        <ul>
                            <li>License renewal: Dec 31, 2024 (1-year commitment â†’ ends Dec 31, 2025)</li>
                            <li>Migration completes: Jun 1, 2025</li>
                            <li>Result: Pay VMware costs until Dec 31, 2025 (despite being migrated)</li>
                            <li>Savings start: Jan 1, 2026</li>
                        </ul>
                    </div>

                    <div class="formula-box">
                        <h4>Hardware Refresh Costs</h4>
                        <p><strong>Refresh Cost = Hardware Portion Ã— Cost Multiplier Ã— (Refresh % / 100)</strong></p>
                        <p><strong>Refresh Timing:</strong> Based on hardware age and refresh cycle</p>
                        <p><strong>Current Age = (Today - Purchase Date) / 365.25 days</strong></p>
                        <p><strong>Next Refresh = Ceiling(Current Age / Cycle) Ã— Cycle</strong></p>
                    </div>

                    <div class="formula-box">
                        <h4>Modernisation Timeline</h4>
                        <p><strong>Modernisation Start Year = Ceiling(Timeline in Months / 12)</strong></p>
                        <p>Savings from node reduction and native Azure services begin after this period.</p>
                    </div>

                    <div class="formula-box">
                        <h4>VMware License Inflation Impact</h4>
                        <p><strong>Why VMware Costs Increase Faster:</strong></p>
                        <ul>
                            <li>Broadcom acquisition of VMware has led to significant licensing changes</li>
                            <li>Per-core licensing models often result in higher costs</li>
                            <li>Support bundling requirements increase overall costs</li>
                            <li>Typical inflation rates: 5-15% annually vs 3-5% general IT inflation</li>
                        </ul>
                        <p>This inflation makes staying on-premises increasingly expensive over time, improving the business case for migration to Azure VMware Solution.</p>
                    </div>
                </div>

                <div class="section">
                    <h3>Azure Cost Components</h3>
                    
                    <div class="formula-box">
                        <h4>AVS Node Costs</h4>
                        <p><strong>Monthly AVS Cost = Node Cost Ã— Number of Nodes Ã— Pricing Tier</strong></p>
                        <p><strong>Node Types Available:</strong></p>
                        <ul>
                            <li><strong>AV36:</strong> 36 cores, 576GB RAM, 15.36TB vSAN - Balanced for general workloads</li>
                            <li><strong>AV36P:</strong> 36 cores, 768GB RAM, 15.36TB vSAN - Memory-enhanced for RAM-intensive apps</li>
                            <li><strong>AV52:</strong> 52 cores, 1536GB RAM, 30.72TB vSAN - High-performance for demanding workloads</li>
                            <li><strong>AV64:</strong> 64 cores, 512GB RAM, 15.36TB vSAN - CPU-optimized for compute-intensive apps</li>
                        </ul>
                        <p><strong>Pricing Tiers:</strong></p>
                        <ul>
                            <li>Pay-as-you-go: Full price</li>
                            <li>1-Year Reserved: ~20% discount</li>
                            <li>3-Year Reserved: ~40% discount</li>
                        </ul>
                        <p><strong>Azure Hybrid Benefit:</strong> ~40% additional savings on compute portion</p>
                    </div>

                    <div class="formula-box">
                        <h4>Total Azure Annual Cost</h4>
                        <p><strong>Annual Azure Cost = (AVS Nodes + Additional Services) Ã— 12</strong></p>
                        <p><strong>Additional Services:</strong> ExpressRoute + Backup + Data Transfer + Monitoring + Storage + Security</p>
                    </div>
                </div>

                <div class="section">
                    <h3>Key Input Categories</h3>
                    
                    <div class="breakdown">
                        <table class="breakdown-table">
                            <thead>
                                <tr>
                                    <th>Category</th>
                                    <th>Key Inputs</th>
                                    <th>Impact on Calculation</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>Current Environment</strong></td>
                                    <td>Cost method, hardware/software costs, staff costs, facilities</td>
                                    <td>Determines baseline annual costs and hardware refresh schedule</td>
                                </tr>
                                <tr>
                                    <td><strong>Hardware Refresh</strong></td>
                                    <td>Purchase date, refresh cycle, cost multiplier, percentage</td>
                                    <td>Calculates timing and cost of on-premises hardware refreshes</td>
                                </tr>
                                <tr>
                                    <td><strong>Azure Configuration</strong></td>
                                    <td>Node type, count, reserved terms, hybrid benefits</td>
                                    <td>Determines base Azure VMware Solution costs</td>
                                </tr>
                                <tr>
                                    <td><strong>Azure Services</strong></td>
                                    <td>ExpressRoute, backup, monitoring, security services</td>
                                    <td>Additional monthly Azure service costs</td>
                                </tr>
                                <tr>
                                    <td><strong>Modernisation</strong></td>
                                    <td>VMs to migrate, applications to modernise, timeline</td>
                                    <td>Calculates savings from moving to native Azure services</td>
                                </tr>
                                                        <tr>
                            <td><strong>Migration Investment</strong></td>
                            <td>Assessment, tools, services, training, contingency</td>
                            <td>One-time costs that must be recovered through savings</td>
                        </tr>
                        <tr>
                            <td><strong>Migration Timeline</strong></td>
                            <td>Start date, duration in months</td>
                            <td>Determines when cost savings begin and VMware license obligations end</td>
                        </tr>
                                <tr>
                                    <td><strong>Partner Funding</strong></td>
                                    <td>Microsoft funding, Azure credits, services funding, training funding</td>
                                    <td>Reduces net migration investment and improves ROI</td>
                                </tr>
                                <tr>
                                    <td><strong>Financial Analysis Parameters</strong></td>
                                    <td>Analysis period, growth rate</td>
                                    <td>Controls analysis timeframe and cost growth projections</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="section">
                    <h3>Assumptions and Limitations</h3>
                    
                    <div class="formula-box">
                        <h4>Key Assumptions</h4>
                        <ul>
                            <li><strong>Calendar Year Analysis:</strong> Each year runs January 1st to December 31st for logical business planning</li>
                            <li><strong>Migration Timing:</strong> VMware license costs stop completely when migration completes</li>
                            <li><strong>Post-Migration:</strong> Zero VMware license costs after migration completion date</li>
                            <li><strong>Simplified Approach:</strong> Single annual hardware cost input with constant costs</li>
                            <li><strong>Fixed Cost Method:</strong> One input covers all hardware operational costs</li>
                            <li><strong>Staff Reduction:</strong> 30% reduction in staff costs with Azure (breakdown method)</li>
                            <li><strong>Constant Costs:</strong> All costs remain the same each year for clear comparison</li>
                            <li><strong>Hardware Refresh:</strong> Occurs when equipment reaches refresh cycle age</li>
                            <li><strong>Modernisation:</strong> Savings begin after modernisation timeline</li>
                            <li><strong>Simple Calculations:</strong> No discounting or time value of money adjustments</li>
                            <li><strong>Currency:</strong> All costs in GBP (Â£)</li>
                        </ul>
                    </div>

                    <div class="formula-box">
                        <h4>Limitations</h4>
                        <ul>
                            <li>Does not include intangible benefits (agility, innovation, scalability)</li>
                            <li>Azure pricing is estimated and may vary by region and contract terms</li>
                            <li>Assumes steady-state operations after migration completion</li>
                            <li>Does not account for business disruption during migration</li>
                            <li>Hardware refresh timing assumes uniform equipment age</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="results" class="tab-content">
            <div class="section">
                <h2>ROI Analysis & Calculations</h2>
                
                <div class="formula-box">
                    <h4>Financial Analysis Formulas</h4>
                    <p><strong>ROI = (Total Savings - Total Investment) / Total Investment Ã— 100</strong></p>
                    <p><strong>Payback Period = Time when Cumulative Savings â‰¥ Total Investment</strong></p>
                    <p><strong>Simplified Approach = All costs remain constant each year for clear comparison</strong></p>
                    <p><strong>License Renewal Timing = VMware cost depends on renewal date vs migration completion date</strong></p>
                    <p><em>Note: After calculation, detailed step-by-step breakdowns show exactly how each value was computed.</em></p>
                </div>

                <div class="section">
                    <h3>Financial Analysis Parameters</h3>
                    <div class="input-group">
                        <div class="input-field">
                            <label>Analysis Period (Years)
                                <span class="info-icon">i
                                    <span class="tooltip">Time period for ROI analysis. Typically 3-5 years to capture full benefits of cloud migration.</span>
                                </span>
                            </label>
                            <input type="number" id="analysis_period" value="5" step="1" min="1" max="10">
                        </div>
                        <div class="input-field">
                            <!-- Empty for grid alignment -->
                        </div>
                    </div>
                </div>
                
                <button class="calculate-btn" onclick="calculateROI()">Calculate ROI & TCO</button>
                
                <div id="roi-results" class="results" style="display: none;">
                    <h2>Financial Analysis Results</h2>
                    
                    <div class="metric">
                        <span class="metric-label">Return on Investment (ROI)</span>
                        <span class="metric-value" id="roi-percentage">0%</span>
                    </div>
                    
                    <div class="metric">
                        <span class="metric-label">Payback Period</span>
                        <span class="metric-value" id="payback-period">0 years</span>
                    </div>
                    
                    <div class="metric">
                        <span class="metric-label">Total Cost Savings</span>
                        <span class="metric-value positive" id="total-savings">Â£0</span>
                    </div>
                    
                    <div class="metric">
                        <span class="metric-label">Gross Investment</span>
                        <span class="metric-value" id="gross-investment">Â£0</span>
                    </div>
                    
                    <div class="metric">
                        <span class="metric-label">Partner Funding</span>
                        <span class="metric-value funding" id="partner-funding">Â£0</span>
                    </div>
                    
                    <div class="metric">
                        <span class="metric-label">Net Investment</span>
                        <span class="metric-value" id="total-investment">Â£0</span>
                    </div>
                    
                    <div class="metric">
                        <span class="metric-label">Total Benefits (5 Years)</span>
                        <span class="metric-value" id="total-benefits">Â£0</span>
                    </div>

                    <div class="metric">
                        <span class="metric-label">Modernisation Savings (5 Years)</span>
                        <span class="metric-value positive" id="modernisation-savings">Â£0</span>
                    </div>
                    
                    <div class="breakdown">
                        <h3>Annual Cost Comparison</h3>
                        <p style="color: #666; font-style: italic; margin-bottom: 15px;">
                            ðŸ“Š The table below shows year-by-year cost comparison using <strong>calendar years</strong> (January to December). The row highlighted in <span style="background-color: #d4edda; padding: 2px 4px; border-radius: 3px; color: #28a745; font-weight: bold;">green</span> indicates when your migration investment is fully recovered through cumulative savings.
                        </p>
                        <p style="color: #666; font-style: italic; margin-bottom: 15px;">
                            ðŸ“… <strong>Year Explanation:</strong> Year 1 = Current calendar year, Year 2 = Next calendar year, etc. Each year runs from January 1st to December 31st for logical business planning.
                        </p>
                        <p style="color: #666; font-style: italic; margin-bottom: 15px;">
                            ðŸ’¡ <strong>VMware License Saved</strong> shows the amount you avoid paying by migrating to Azure instead of staying on-premises and paying VMware license costs.
                        </p>
                        <p style="color: #666; font-style: italic; margin-bottom: 15px;">
                            ðŸ“Š Click the <strong>"ðŸ“Š Details"</strong> button next to any year to see the detailed calculation breakdown for that specific year.
                        </p>
                        <table class="breakdown-table">
                            <thead>
                                <tr>
                                    <th>Year</th>
                                    <th>On-Premises Cost</th>
                                    <th>Hardware Refresh</th>
                                    <th>VMware License Saved</th>
                                    <th>Azure Cost</th>
                                    <th>Modernisation Savings</th>
                                    <th>Annual Savings</th>
                                    <th>Cumulative Savings</th>
                                </tr>
                            </thead>
                            <tbody id="yearly-breakdown">
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="breakdown">
                        <h3>Cost Breakdown Summary</h3>
                        <table class="breakdown-table">
                            <thead>
                                <tr>
                                    <th>Category</th>
                                    <th>On-Premises (Annual)</th>
                                    <th>Azure (Annual)</th>
                                    <th>Difference</th>
                                </tr>
                            </thead>
                            <tbody id="cost-breakdown">
                            </tbody>
                        </table>
                    </div>

                    <div class="breakdown">
                        <h3>Detailed Calculation Breakdown</h3>
                        <div id="calculation-details">
                            <!-- Calculation details will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Set default migration start date to 30 days from today if not already set
            const migrationStartInput = document.getElementById('migration_start_date');
            if (!migrationStartInput.value) {
                const defaultStartDate = new Date();
                defaultStartDate.setDate(defaultStartDate.getDate() + 30);
                migrationStartInput.value = defaultStartDate.toISOString().split('T')[0];
            }
            
            updateRefreshSchedule();
            updateMigrationSchedule();
        });

        function showTab(tabName) {
            // Hide all tab contents
            const contents = document.querySelectorAll('.tab-content');
            contents.forEach(content => content.classList.remove('active'));
            
            // Remove active class from all tabs
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            // Show selected tab content
            document.getElementById(tabName).classList.add('active');
            
            // Add active class to clicked tab
            event.target.classList.add('active');
        }

                 function toggleCostMethod() {
             const fixedCostSection = document.getElementById('fixed-cost-section');
             const breakdownCostSection = document.getElementById('breakdown-cost-section');
             const fixedCostInput = document.getElementById('fixed_annual_cost');
             const breakdownInputs = document.querySelectorAll('#breakdown-cost-section .input-field input');

             if (document.querySelector('input[name="cost_method"]:checked').value === 'fixed') {
                 fixedCostSection.style.display = 'block';
                 breakdownCostSection.style.display = 'none';
                 fixedCostInput.setAttribute('required', 'required');
                 breakdownInputs.forEach(input => input.removeAttribute('required'));
             } else {
                 fixedCostSection.style.display = 'none';
                 breakdownCostSection.style.display = 'block';
                 fixedCostInput.removeAttribute('required');
                 breakdownInputs.forEach(input => input.setAttribute('required', 'required'));
             }
             updateRefreshSchedule();
         }

         function updateRefreshSchedule() {
             const purchaseDateInput = document.getElementById('hardware_purchase_date');
             const refreshCycleInput = document.getElementById('refresh_cycle_years');
             const refreshPercentageInput = document.getElementById('refresh_percentage');
             const refreshMultiplierInput = document.getElementById('refresh_cost_multiplier');
             const endOfSupportInput = document.getElementById('hardware_end_of_support');
             const endOfLifeInput = document.getElementById('hardware_end_of_life');
             
             if (!purchaseDateInput.value || !refreshCycleInput.value) {
                 document.getElementById('refresh-schedule-text').textContent = 'Configure hardware refresh settings above to see the schedule.';
                 return;
             }

             const purchaseDate = new Date(purchaseDateInput.value);
             const currentDate = new Date();
             const refreshCycle = parseInt(refreshCycleInput.value);
             const refreshPercentage = parseFloat(refreshPercentageInput.value);
             const refreshMultiplier = parseFloat(refreshMultiplierInput.value);
             
             const yearsOld = (currentDate - purchaseDate) / (1000 * 60 * 60 * 24 * 365.25);
             const nextRefreshAge = Math.ceil(yearsOld / refreshCycle) * refreshCycle;
             const yearsUntilRefresh = nextRefreshAge - yearsOld;
             
             const nextRefreshDate = new Date(currentDate);
             nextRefreshDate.setFullYear(nextRefreshDate.getFullYear() + yearsUntilRefresh);
             
             let scheduleText = `Hardware is ${yearsOld.toFixed(1)} years old. `;
             
             if (yearsUntilRefresh < 1) {
                 scheduleText += `Next refresh is due now! `;
             } else {
                 scheduleText += `Next refresh due in ${yearsUntilRefresh.toFixed(1)} years (${nextRefreshDate.getFullYear()}). `;
             }
             
             scheduleText += `${refreshPercentage}% of hardware will be refreshed at ${((refreshMultiplier - 1) * 100).toFixed(0)}% cost increase.`;
             
             // Add end of support and end of life information
             if (endOfSupportInput.value) {
                 const endOfSupportDate = new Date(endOfSupportInput.value);
                 const daysUntilEndOfSupport = Math.ceil((endOfSupportDate - currentDate) / (1000 * 60 * 60 * 24));
                 
                 if (daysUntilEndOfSupport < 0) {
                     scheduleText += ` âš ï¸ Hardware support ended ${Math.abs(daysUntilEndOfSupport)} days ago (${endOfSupportDate.toDateString()}).`;
                 } else if (daysUntilEndOfSupport < 365) {
                     scheduleText += ` âš ï¸ Hardware support ends in ${daysUntilEndOfSupport} days (${endOfSupportDate.toDateString()}).`;
                 } else {
                     scheduleText += ` Support ends ${endOfSupportDate.toDateString()}.`;
                 }
             }
             
             if (endOfLifeInput.value) {
                 const endOfLifeDate = new Date(endOfLifeInput.value);
                 const daysUntilEndOfLife = Math.ceil((endOfLifeDate - currentDate) / (1000 * 60 * 60 * 24));
                 
                 if (daysUntilEndOfLife < 0) {
                     scheduleText += ` ðŸš¨ Hardware reached end of life ${Math.abs(daysUntilEndOfLife)} days ago (${endOfLifeDate.toDateString()}).`;
                 } else if (daysUntilEndOfLife < 365) {
                     scheduleText += ` ðŸš¨ Hardware reaches end of life in ${daysUntilEndOfLife} days (${endOfLifeDate.toDateString()}).`;
                 } else {
                     scheduleText += ` End of life: ${endOfLifeDate.toDateString()}.`;
                 }
             }
             
             document.getElementById('refresh-schedule-text').textContent = scheduleText;
         }

         function updateMigrationSchedule() {
             const migrationStartInput = document.getElementById('migration_start_date');
             const migrationTimelineInput = document.getElementById('migration_timeline');
             
             if (!migrationStartInput.value || !migrationTimelineInput.value) {
                 document.getElementById('migration-schedule-text').textContent = 'Configure migration start date and duration above to see the timeline.';
                 return;
             }

             const migrationStartDate = new Date(migrationStartInput.value);
             const migrationDuration = parseInt(migrationTimelineInput.value);
             const migrationCompletionDate = new Date(migrationStartDate);
             migrationCompletionDate.setMonth(migrationCompletionDate.getMonth() + migrationDuration);
             
             const currentDate = new Date();
             const daysUntilStart = Math.ceil((migrationStartDate - currentDate) / (1000 * 60 * 60 * 24));
             
             let scheduleText = '';
             
             if (daysUntilStart > 0) {
                 scheduleText += `Migration starts in ${daysUntilStart} days (${migrationStartDate.toDateString()}). `;
             } else if (daysUntilStart < 0) {
                 scheduleText += `Migration was scheduled to start ${Math.abs(daysUntilStart)} days ago (${migrationStartDate.toDateString()}). `;
             } else {
                 scheduleText += `Migration starts today (${migrationStartDate.toDateString()}). `;
             }
             
             scheduleText += `Duration: ${migrationDuration} months. `;
             scheduleText += `Completion: ${migrationCompletionDate.toDateString()}.`;
             
             // Add license renewal interaction including commitment period
             const licenseRenewalInput = document.getElementById('license_renewal_date');
             const licenseCommitmentInput = document.getElementById('license_commitment_years');
             if (licenseRenewalInput.value && licenseCommitmentInput.value) {
                 const licenseRenewalDate = new Date(licenseRenewalInput.value);
                 const commitmentYears = parseInt(licenseCommitmentInput.value);
                 const licenseCommitmentEndDate = new Date(licenseRenewalDate);
                 licenseCommitmentEndDate.setFullYear(licenseCommitmentEndDate.getFullYear() + commitmentYears);
                 
                 if (migrationCompletionDate <= licenseRenewalDate) {
                     scheduleText += ` âœ… Migration completes BEFORE license renewal - avoiding price increases completely!`;
                 } else if (migrationCompletionDate <= licenseCommitmentEndDate) {
                     const monthsOfPayment = Math.ceil((licenseCommitmentEndDate - migrationCompletionDate) / (1000 * 60 * 60 * 24 * 30.44));
                     scheduleText += ` âš ï¸ CRITICAL: Migration completes ${migrationCompletionDate.toDateString()} but license commitment extends to ${licenseCommitmentEndDate.toDateString()}.`;
                     scheduleText += ` You'll pay for ~${monthsOfPayment} extra months after migration!`;
                 } else {
                     scheduleText += ` âœ… Migration completes after license commitment ends - optimal timing.`;
                 }
             }
             
             document.getElementById('migration-schedule-text').textContent = scheduleText;
         }

         // Add event listeners for refresh schedule updates
         document.addEventListener('DOMContentLoaded', function() {
             document.getElementById('hardware_purchase_date').addEventListener('change', updateRefreshSchedule);
             document.getElementById('refresh_cycle_years').addEventListener('input', updateRefreshSchedule);
             document.getElementById('refresh_percentage').addEventListener('input', updateRefreshSchedule);
             document.getElementById('refresh_cost_multiplier').addEventListener('input', updateRefreshSchedule);
             document.getElementById('hardware_end_of_support').addEventListener('change', updateRefreshSchedule);
             document.getElementById('hardware_end_of_life').addEventListener('change', updateRefreshSchedule);
             
             // Migration schedule event listeners
             document.getElementById('migration_start_date').addEventListener('change', updateMigrationSchedule);
             document.getElementById('migration_timeline').addEventListener('input', updateMigrationSchedule);
             document.getElementById('license_renewal_date').addEventListener('change', updateMigrationSchedule);
         });

        function calculateROI() {
            // Get cost calculation method
            const costMethod = document.querySelector('input[name="cost_method"]:checked').value;
            
            // Get all input values
            const inputs = {
                // Cost method and fixed cost
                cost_method: costMethod,
                fixed_annual_cost: parseFloat(document.getElementById('fixed_annual_cost').value) || 0,
                
                // Current environment costs (breakdown method)
                hardware_cost: parseFloat(document.getElementById('hardware_cost').value) || 0,
                vmware_licensing: parseFloat(document.getElementById('vmware_licensing').value) || 0,
                storage_hardware: parseFloat(document.getElementById('storage_hardware').value) || 0,
                network_equipment: parseFloat(document.getElementById('network_equipment').value) || 0,
                backup_hardware: parseFloat(document.getElementById('backup_hardware').value) || 0,
                support_contracts: parseFloat(document.getElementById('support_contracts').value) || 0,
                datacenter_space: parseFloat(document.getElementById('datacenter_space').value) || 0,
                power_cooling: parseFloat(document.getElementById('power_cooling').value) || 0,
                staff_costs: parseFloat(document.getElementById('staff_costs').value) || 0,
                connectivity: parseFloat(document.getElementById('connectivity').value) || 0,
                
                // Hardware refresh planning
                hardware_purchase_date: document.getElementById('hardware_purchase_date').value,
                refresh_cycle_years: parseInt(document.getElementById('refresh_cycle_years').value) || 4,
                refresh_cost_multiplier: parseFloat(document.getElementById('refresh_cost_multiplier').value) || 1.15,
                refresh_percentage: parseFloat(document.getElementById('refresh_percentage').value) || 85,
                
                // Azure costs
                avs_node_type: document.getElementById('avs_node_type').value,
                avs_clusters: parseInt(document.getElementById('avs_clusters').value) || 1,
                avs_nodes: parseInt(document.getElementById('avs_nodes').value) || 3,
                reserved_term: document.getElementById('reserved_term').value,
                hybrid_benefit: document.getElementById('hybrid_benefit').value,
                expressroute: parseFloat(document.getElementById('expressroute').value) || 0,
                azure_backup: parseFloat(document.getElementById('azure_backup').value) || 0,
                data_transfer: parseFloat(document.getElementById('data_transfer').value) || 0,
                monitoring: parseFloat(document.getElementById('monitoring').value) || 0,
                additional_storage: parseFloat(document.getElementById('additional_storage').value) || 0,
                security_services: parseFloat(document.getElementById('security_services').value) || 0,
                
                // Modernisation inputs
                vms_to_azure: parseFloat(document.getElementById('vms_to_azure').value) || 0,
                apps_to_paas: parseInt(document.getElementById('apps_to_paas').value) || 0,
                databases_to_managed: parseInt(document.getElementById('databases_to_managed').value) || 0,
                fileservers_to_azure: parseInt(document.getElementById('fileservers_to_azure').value) || 0,
                nodes_saved: parseInt(document.getElementById('nodes_saved').value) || 0,
                license_reduction: parseFloat(document.getElementById('license_reduction').value) || 0,
                modernisation_timeline: parseInt(document.getElementById('modernisation_timeline').value) || 12,
                modernisation_investment: parseFloat(document.getElementById('modernisation_investment').value) || 0,
                azure_vms_cost: parseFloat(document.getElementById('azure_vms_cost').value) || 0,
                paas_cost: parseFloat(document.getElementById('paas_cost').value) || 0,
                managed_db_cost: parseFloat(document.getElementById('managed_db_cost').value) || 0,
                azure_storage_cost: parseFloat(document.getElementById('azure_storage_cost').value) || 0,
                
                // Migration costs
                assessment: parseFloat(document.getElementById('assessment').value) || 0,
                professional_services: parseFloat(document.getElementById('professional_services').value) || 0,
                service_transition: parseFloat(document.getElementById('service_transition').value) || 0,
                contingency: parseFloat(document.getElementById('contingency').value) || 0,
                
                // VMware license renewal details
                current_vmware_cost: parseFloat(document.getElementById('current_vmware_cost').value) || 0,
                license_renewal_date: document.getElementById('license_renewal_date').value,
                new_vmware_cost: parseFloat(document.getElementById('new_vmware_cost').value) || 0,
                license_commitment_years: parseInt(document.getElementById('license_commitment_years').value) || 1,
                
                // Partner funding & incentives
                migration_funding: parseFloat(document.getElementById('migration_funding').value) || 0,
                azure_credits: parseFloat(document.getElementById('azure_credits').value) || 0,
                additional_incentives: parseFloat(document.getElementById('additional_incentives').value) || 0,
                
                // Analysis parameters
                analysis_period: parseInt(document.getElementById('analysis_period').value) || 5,
                migration_timeline: parseInt(document.getElementById('migration_timeline').value) || 6,
                migration_start_date: document.getElementById('migration_start_date').value
            };

            // Calculate annual on-premises costs based on method
            let baseAnnualOnPremCosts;
            let hardwareRelatedCosts;
            
            if (inputs.cost_method === 'fixed') {
                baseAnnualOnPremCosts = inputs.fixed_annual_cost;
                hardwareRelatedCosts = inputs.fixed_annual_cost; // Use same value for hardware refresh calculations
            } else {
                baseAnnualOnPremCosts = inputs.hardware_cost + inputs.vmware_licensing + 
                    inputs.storage_hardware + inputs.network_equipment + inputs.backup_hardware + 
                    inputs.support_contracts + inputs.datacenter_space + inputs.power_cooling + 
                    inputs.staff_costs + inputs.connectivity;
                hardwareRelatedCosts = inputs.hardware_cost + inputs.storage_hardware + inputs.network_equipment;
            }

            // Calculate hardware refresh timing and costs
            const purchaseDate = new Date(inputs.hardware_purchase_date);
            const currentDate = new Date();
            const yearsOld = (currentDate - purchaseDate) / (1000 * 60 * 60 * 24 * 365.25);
            
            function calculateRefreshCosts(year) {
                // Calculate what calendar year we're analyzing
                const analysisYear = currentDate.getFullYear() + year - 1;
                
                // Calculate how old the hardware will be in the analysis year
                const hardwareAgeInAnalysisYear = analysisYear - purchaseDate.getFullYear();
                
                // Check if refresh is due in this specific year
                const refreshYear = Math.ceil(yearsOld / inputs.refresh_cycle_years) * inputs.refresh_cycle_years;
                const refreshCalendarYear = purchaseDate.getFullYear() + refreshYear;
                
                // If refresh happens in this analysis year
                if (refreshCalendarYear === analysisYear) {
                    const refreshCost = hardwareRelatedCosts * inputs.refresh_cost_multiplier * (inputs.refresh_percentage / 100);
                    return refreshCost;
                }
                return 0;
            }

            // Calculate AVS node costs based on type and terms (converted to GBP, roughly)
            const nodeCosts = {
                'AV36': { payg: 7000, '1year': 5600, '3year': 4200 },
                'AV36P': { payg: 9350, '1year': 7480, '3year': 5610 },
                'AV52': { payg: 14000, '1year': 11200, '3year': 8400 },
                'AV64': { payg: 11200, '1year': 8960, '3year': 6720 }
            };

            let monthlyAvsNodeCost = nodeCosts[inputs.avs_node_type][inputs.reserved_term] * inputs.avs_nodes * inputs.avs_clusters;
            
            // Apply Azure Hybrid Benefit (approximately 40% savings on compute)
            if (inputs.hybrid_benefit === 'yes') {
                monthlyAvsNodeCost *= 0.6;
            }

            // Calculate total monthly Azure costs
            const monthlyAzureCosts = monthlyAvsNodeCost + inputs.expressroute + inputs.azure_backup + 
                inputs.data_transfer + inputs.monitoring + inputs.additional_storage + inputs.security_services;

            let annualAzureCosts = monthlyAzureCosts * 12;

            // Calculate modernisation costs and savings
            const annualModernisationServiceCosts = (inputs.azure_vms_cost + inputs.paas_cost + 
                inputs.managed_db_cost + inputs.azure_storage_cost) * 12;

            // Calculate migration investment including modernisation
            const migrationCosts = inputs.assessment + inputs.professional_services + inputs.service_transition;
            const grossMigrationCosts = migrationCosts * (1 + inputs.contingency / 100) + inputs.modernisation_investment;
            
            // Calculate total partner funding and incentives
            const totalPartnerFunding = inputs.migration_funding + inputs.azure_credits + inputs.additional_incentives;
            
            // Net migration costs after partner funding
            const totalMigrationCosts = Math.max(0, grossMigrationCosts - totalPartnerFunding);

            // Calculate savings and ROI with modernisation timeline
            let totalBenefits = 0;
            let totalModernisationSavings = 0;
            const modernisationStartYear = Math.ceil(inputs.modernisation_timeline / 12);

            // Helper function to calculate VMware license cost for a given year
            function calculateVMwareLicenseCost(year) {
                const currentDate = new Date();
                const renewalDate = new Date(inputs.license_renewal_date);
                
                // Calculate migration completion date based on start date
                let migrationCompletionDate;
                if (inputs.migration_start_date) {
                    migrationCompletionDate = new Date(inputs.migration_start_date);
                    migrationCompletionDate.setMonth(migrationCompletionDate.getMonth() + inputs.migration_timeline);
                } else {
                    // Fallback to current behavior if no start date specified
                    migrationCompletionDate = new Date(currentDate);
                    migrationCompletionDate.setMonth(migrationCompletionDate.getMonth() + inputs.migration_timeline);
                }
                
                // Use calendar years starting from current year for logical business analysis
                const yearStartDate = new Date(currentDate.getFullYear() + year - 1, 0, 1); // January 1st of the analysis year
                const yearEndDate = new Date(currentDate.getFullYear() + year, 0, 1); // January 1st of next year
                
                // Calculate license commitment end date (when you can actually stop paying)
                const licenseCommitmentEndDate = new Date(renewalDate);
                licenseCommitmentEndDate.setFullYear(licenseCommitmentEndDate.getFullYear() + inputs.license_commitment_years);
                
                // Key logic: You must pay VMware costs until BOTH conditions are met:
                // 1. Migration is complete AND 2. License commitment period has ended
                const canStopPayingDate = new Date(Math.max(migrationCompletionDate.getTime(), licenseCommitmentEndDate.getTime()));
                
                // If you can stop paying before this year starts, no VMware license cost
                if (canStopPayingDate <= yearStartDate) {
                    return 0;
                }
                
                // Calculate how many days in this year you must pay license costs
                let licenseDaysInYear = (yearEndDate - yearStartDate) / (1000 * 60 * 60 * 24);
                if (canStopPayingDate > yearStartDate && canStopPayingDate < yearEndDate) {
                    licenseDaysInYear = (canStopPayingDate - yearStartDate) / (1000 * 60 * 60 * 24);
                }
                
                // Determine which license cost applies
                let annualLicenseCost = inputs.current_vmware_cost;
                
                // If renewal date falls before or during this year, use new cost
                if (renewalDate <= yearEndDate) {
                    // Check if we're in renewal period
                    if (renewalDate <= yearStartDate) {
                        // Renewal already happened, use new cost
                        annualLicenseCost = inputs.new_vmware_cost;
                    } else if (renewalDate > yearStartDate && renewalDate <= yearEndDate) {
                        // Renewal happens during this year - calculate weighted average
                        const daysOldPrice = (renewalDate - yearStartDate) / (1000 * 60 * 60 * 24);
                        const daysNewPrice = licenseDaysInYear - daysOldPrice;
                        if (daysNewPrice > 0) {
                            annualLicenseCost = (inputs.current_vmware_cost * daysOldPrice + inputs.new_vmware_cost * daysNewPrice) / licenseDaysInYear;
                        }
                    }
                }
                
                return (annualLicenseCost * licenseDaysInYear / 365);
            }

            // Helper function to calculate what VMware license cost WOULD BE if no migration occurred
            function calculateVMwareLicenseCostWithoutMigration(year) {
                const currentDate = new Date();
                const renewalDate = new Date(inputs.license_renewal_date);
                
                // Use calendar years starting from current year for logical business analysis
                const yearStartDate = new Date(currentDate.getFullYear() + year - 1, 0, 1); // January 1st of the analysis year
                const yearEndDate = new Date(currentDate.getFullYear() + year, 0, 1); // January 1st of next year
                
                // Determine which license cost applies (without considering migration)
                let annualLicenseCost = inputs.current_vmware_cost;
                
                // If renewal date falls before or during this year, use new cost
                if (renewalDate <= yearEndDate) {
                    // Check if we're in renewal period
                    if (renewalDate <= yearStartDate) {
                        // Renewal already happened, use new cost
                        annualLicenseCost = inputs.new_vmware_cost;
                    } else if (renewalDate > yearStartDate && renewalDate <= yearEndDate) {
                        // Renewal happens during this year - calculate weighted average
                        const monthsOldPrice = (renewalDate - yearStartDate) / (1000 * 60 * 60 * 24 * 30.44);
                        const monthsNewPrice = 12 - monthsOldPrice;
                        annualLicenseCost = (inputs.current_vmware_cost * monthsOldPrice + inputs.new_vmware_cost * monthsNewPrice) / 12;
                    }
                }
                
                return annualLicenseCost;
            }

            const yearlyBreakdown = [];
            let cumulativeSavings = 0;

            for (let year = 1; year <= inputs.analysis_period; year++) {
                // Calculate VMware license cost for this year
                const vmwareLicenseCost = calculateVMwareLicenseCost(year);
                
                // Calculate on-premises costs with license renewal timing
                let yearlyOnPremCost;
                if (inputs.cost_method === 'fixed') {
                    // For fixed method, VMware licensing is handled separately
                    yearlyOnPremCost = baseAnnualOnPremCosts + vmwareLicenseCost;
                } else {
                    // For breakdown method, exclude vmware_licensing and add calculated cost
                    const infrastructureCosts = inputs.hardware_cost + inputs.storage_hardware + inputs.network_equipment + 
                        inputs.backup_hardware + inputs.support_contracts + inputs.datacenter_space + inputs.power_cooling + 
                        inputs.staff_costs + inputs.connectivity;
                    
                    yearlyOnPremCost = infrastructureCosts + vmwareLicenseCost;
                }
                
                // Add hardware refresh costs if they occur this year
                const refreshCost = calculateRefreshCosts(year);
                yearlyOnPremCost += refreshCost;
                
                let yearlyAzureCost = annualAzureCosts;
                let modernisationSavingsThisYear = 0;

                // Apply modernisation savings after the modernisation timeline
                if (year >= modernisationStartYear) {
                    // Reduce AVS costs by saved nodes
                    const nodeCostPerYear = nodeCosts[inputs.avs_node_type][inputs.reserved_term] * 12;
                    const nodesSavings = inputs.nodes_saved * nodeCostPerYear;
                    
                    // Add native Azure service costs
                    const additionalAzureCosts = annualModernisationServiceCosts;
                    
                    modernisationSavingsThisYear = nodesSavings - additionalAzureCosts;
                    yearlyAzureCost -= nodesSavings;
                    yearlyAzureCost += additionalAzureCosts;
                    
                    totalModernisationSavings += modernisationSavingsThisYear;
                }
                
                const yearlySavings = yearlyOnPremCost - yearlyAzureCost;
                
                totalBenefits += yearlySavings;
                cumulativeSavings += yearlySavings;

                // Calculate license cost avoidance for display
                // This shows what you WOULD have paid if you hadn't migrated
                const actualLicenseCost = calculateVMwareLicenseCost(year);
                const wouldHavePaidLicenseCost = calculateVMwareLicenseCostWithoutMigration(year);
                const licenseCostAvoidance = wouldHavePaidLicenseCost - actualLicenseCost;

                yearlyBreakdown.push({
                    year: year,
                    onPremCost: yearlyOnPremCost,
                    azureCost: yearlyAzureCost,
                    refreshCost: refreshCost,
                    licenseCostAvoidance: licenseCostAvoidance,
                    modernisationSavings: modernisationSavingsThisYear,
                    savings: yearlySavings,
                    cumulative: cumulativeSavings
                });
            }

            const roi = totalMigrationCosts > 0 ? ((totalBenefits - totalMigrationCosts) / totalMigrationCosts) * 100 : 0;
            const annualSavings = totalBenefits / inputs.analysis_period;
            
            // Calculate simple payback period using cumulative savings
            function calculateSimplePaybackPeriod(totalMigrationCosts, yearlyBreakdown) {
                let cumulativeSavings = 0;
                
                for (let i = 0; i < yearlyBreakdown.length; i++) {
                    const year = yearlyBreakdown[i];
                    cumulativeSavings += year.savings;
                    
                    if (cumulativeSavings >= totalMigrationCosts) {
                        // Linear interpolation for more precise payback period
                        const previousCumulative = cumulativeSavings - year.savings;
                        const remainingAmount = totalMigrationCosts - previousCumulative;
                        const fractionOfYear = remainingAmount / year.savings;
                        
                        return (year.year - 1) + fractionOfYear;
                    }
                }
                
                // If payback period exceeds analysis period
                return -1; // Indicates no payback within analysis period
            }
            
            const paybackPeriod = calculateSimplePaybackPeriod(totalMigrationCosts, yearlyBreakdown);

            // Display results
            document.getElementById('roi-percentage').textContent = roi.toFixed(1) + '%';
            document.getElementById('roi-percentage').className = 'metric-value ' + (roi > 0 ? 'positive' : 'negative');
            
            document.getElementById('payback-period').textContent = paybackPeriod === -1 ? 
                'No payback within analysis period' : paybackPeriod.toFixed(1) + ' years';
            
            // Add payback year indicator to the payback period metric
            const paybackMetric = document.querySelector('.metric:nth-child(2)');
            if (paybackPeriod !== -1 && paybackPeriod <= inputs.analysis_period) {
                const paybackYear = Math.ceil(paybackPeriod);
                const existingIndicator = paybackMetric.querySelector('.payback-indicator');
                if (existingIndicator) existingIndicator.remove();
                
                const paybackIndicator = document.createElement('div');
                paybackIndicator.className = 'payback-indicator';
                paybackIndicator.innerHTML = `<small style="color: #28a745; font-weight: normal;">ðŸŽ¯ Investment recovered in Year ${paybackYear}</small>`;
                paybackMetric.appendChild(paybackIndicator);
            }
            
            document.getElementById('total-savings').textContent = 'Â£' + totalBenefits.toLocaleString(undefined, {maximumFractionDigits: 0});
            document.getElementById('gross-investment').textContent = 'Â£' + grossMigrationCosts.toLocaleString(undefined, {maximumFractionDigits: 0});
            document.getElementById('partner-funding').textContent = 'Â£' + totalPartnerFunding.toLocaleString(undefined, {maximumFractionDigits: 0});
            document.getElementById('total-investment').textContent = 'Â£' + totalMigrationCosts.toLocaleString(undefined, {maximumFractionDigits: 0});
            document.getElementById('total-benefits').textContent = 'Â£' + totalBenefits.toLocaleString(undefined, {maximumFractionDigits: 0});
            document.getElementById('modernisation-savings').textContent = 'Â£' + totalModernisationSavings.toLocaleString(undefined, {maximumFractionDigits: 0});

            // Populate yearly breakdown table
            const yearlyTable = document.getElementById('yearly-breakdown');
            yearlyTable.innerHTML = '';
            let paybackYearFound = false;
            yearlyBreakdown.forEach((year, index) => {
                const row = yearlyTable.insertRow();
                
                // Year column with expand button
                const yearCell = row.insertCell(0);
                const calendarYear = currentDate.getFullYear() + year.year - 1;
                const yearLabel = `Year ${year.year}<br/><small style="color: #666;">(${calendarYear})</small>`;
                yearCell.innerHTML = `
                    ${yearLabel}
                    <button class="expand-button" onclick="toggleYearDetails(${index})" id="expand-btn-${index}">
                        ðŸ“Š Details
                    </button>
                `;
                
                row.insertCell(1).textContent = 'Â£' + year.onPremCost.toLocaleString(undefined, {maximumFractionDigits: 0});
                
                const refreshCell = row.insertCell(2);
                refreshCell.textContent = 'Â£' + year.refreshCost.toLocaleString(undefined, {maximumFractionDigits: 0});
                if (year.refreshCost > 0) {
                    refreshCell.style.backgroundColor = '#fff3cd';
                    refreshCell.style.color = '#856404';
                    refreshCell.style.fontWeight = 'bold';
                }
                
                const licenseCostAvoidanceCell = row.insertCell(3);
                licenseCostAvoidanceCell.textContent = 'Â£' + year.licenseCostAvoidance.toLocaleString(undefined, {maximumFractionDigits: 0});
                if (year.licenseCostAvoidance > 0) { // Highlight any license savings
                    licenseCostAvoidanceCell.style.backgroundColor = '#d4edda';
                    licenseCostAvoidanceCell.style.color = '#155724';
                    licenseCostAvoidanceCell.style.fontWeight = 'bold';
                }
                
                row.insertCell(4).textContent = 'Â£' + year.azureCost.toLocaleString(undefined, {maximumFractionDigits: 0});
                row.insertCell(5).textContent = 'Â£' + year.modernisationSavings.toLocaleString(undefined, {maximumFractionDigits: 0});
                row.insertCell(6).textContent = 'Â£' + year.savings.toLocaleString(undefined, {maximumFractionDigits: 0});
                
                const cumulativeCell = row.insertCell(7);
                cumulativeCell.textContent = 'Â£' + year.cumulative.toLocaleString(undefined, {maximumFractionDigits: 0});
                
                // Highlight payback recovery point
                if (!paybackYearFound && year.cumulative >= totalMigrationCosts && totalMigrationCosts > 0) {
                    paybackYearFound = true;
                    row.style.backgroundColor = '#d4edda';
                    row.style.border = '2px solid #28a745';
                    row.style.fontWeight = 'bold';
                    
                    // Add payback recovery indicator
                    const paybackIndicator = document.createElement('div');
                    paybackIndicator.innerHTML = 'ðŸŽ¯ <strong>Investment Recovered!</strong>';
                    paybackIndicator.style.color = '#28a745';
                    paybackIndicator.style.fontSize = '12px';
                    paybackIndicator.style.textAlign = 'center';
                    paybackIndicator.style.marginTop = '5px';
                    cumulativeCell.appendChild(paybackIndicator);
                }
                
                // Add detailed breakdown row
                const detailRow = yearlyTable.insertRow();
                const detailCell = detailRow.insertCell(0);
                detailCell.colSpan = 8;
                detailCell.innerHTML = createYearDetailsHTML(year, inputs, index);
                detailCell.style.padding = '0';
            });

            // Populate cost breakdown table
            const costBreakdown = document.getElementById('cost-breakdown');
            costBreakdown.innerHTML = '';
            
            let categories;
            if (inputs.cost_method === 'fixed') {
                categories = [
                    { name: 'Total On-Premises Cost', onPrem: baseAnnualOnPremCosts, azure: annualAzureCosts },
                    { name: 'Azure VMware Solution', onPrem: 0, azure: monthlyAvsNodeCost * 12 },
                    { name: 'Azure Additional Services', onPrem: 0, azure: (inputs.expressroute + inputs.azure_backup + inputs.data_transfer + inputs.monitoring + inputs.additional_storage + inputs.security_services) * 12 }
                ];
            } else {
                categories = [
                    { name: 'Infrastructure Support', onPrem: inputs.hardware_cost + inputs.storage_hardware + inputs.network_equipment, azure: 0 },
                    { name: 'Software Licensing', onPrem: inputs.vmware_licensing, azure: monthlyAvsNodeCost * 12 },
                    { name: 'Support & Maintenance', onPrem: inputs.support_contracts, azure: 0 },
                    { name: 'Facilities & Power', onPrem: inputs.datacenter_space + inputs.power_cooling, azure: 0 },
                    { name: 'Staff Costs', onPrem: inputs.staff_costs, azure: inputs.staff_costs * 0.7 }, // Assume 30% reduction
                    { name: 'Backup & DR', onPrem: inputs.backup_hardware, azure: inputs.azure_backup * 12 },
                    { name: 'Network & Connectivity', onPrem: inputs.connectivity, azure: inputs.expressroute * 12 + inputs.data_transfer * 12 },
                    { name: 'Additional Services', onPrem: 0, azure: (inputs.monitoring + inputs.additional_storage + inputs.security_services) * 12 }
                ];
            }

            categories.forEach(category => {
                const row = costBreakdown.insertRow();
                row.insertCell(0).textContent = category.name;
                row.insertCell(1).textContent = 'Â£' + category.onPrem.toLocaleString(undefined, {maximumFractionDigits: 0});
                row.insertCell(2).textContent = 'Â£' + category.azure.toLocaleString(undefined, {maximumFractionDigits: 0});
                const difference = category.onPrem - category.azure;
                const cell = row.insertCell(3);
                cell.textContent = 'Â£' + difference.toLocaleString(undefined, {maximumFractionDigits: 0});
                cell.className = difference > 0 ? 'positive' : 'negative';
            });

            // Populate detailed calculation breakdown
            const calculationDetails = document.getElementById('calculation-details');
            let detailsHtml = '';

            // Base costs section
            detailsHtml += `
                <div class="calculation-section">
                    <h4>1. Base Cost Calculation</h4>
                    <div class="calculation-formula">Method: ${inputs.cost_method === 'fixed' ? 'Fixed Annual Cost' : 'Detailed Cost Breakdown'}</div>
            `;
            
            if (inputs.cost_method === 'fixed') {
                detailsHtml += `
                    <div class="calculation-step">Annual Hardware Costs = Â£${inputs.fixed_annual_cost.toLocaleString()}</div>
                    <div class="calculation-step">Note: VMware licensing costs are calculated separately based on renewal timing</div>
                `;
            } else {
                detailsHtml += `
                    <div class="calculation-step">Infrastructure Support Costs = Â£${(inputs.hardware_cost + inputs.storage_hardware + inputs.network_equipment + inputs.backup_hardware + inputs.support_contracts + inputs.datacenter_space + inputs.power_cooling + inputs.staff_costs + inputs.connectivity).toLocaleString()}</div>
                    <div class="calculation-step">VMware Licensing = Â£${inputs.vmware_licensing.toLocaleString()}</div>
                    <div class="calculation-step">Note: Hardware support costs exclude depreciation of purchased equipment (sunk costs)</div>
                `;
            }
            
            detailsHtml += `
                    <div class="calculation-result">Total Base Annual On-Premises Cost = Â£${baseAnnualOnPremCosts.toLocaleString()} (excluding VMware licensing)</div>
                </div>
            `;

            // Azure costs section
            detailsHtml += `
                <div class="calculation-section">
                    <h4>2. Azure VMware Solution Cost Calculation</h4>
                    <div class="calculation-step">Node Type: ${inputs.avs_node_type}</div>
                    <div class="calculation-step">Number of Clusters: ${inputs.avs_clusters}</div>
                    <div class="calculation-step">Nodes Per Cluster: ${inputs.avs_nodes}</div>
                    <div class="calculation-step">Total Nodes: ${inputs.avs_clusters * inputs.avs_nodes}</div>
                    <div class="calculation-step">Reserved Term: ${inputs.reserved_term}</div>
                    <div class="calculation-step">Node Cost per Month = Â£${(nodeCosts[inputs.avs_node_type][inputs.reserved_term]).toLocaleString()}</div>
                    <div class="calculation-step">Total Monthly AVS Cost = Â£${(nodeCosts[inputs.avs_node_type][inputs.reserved_term]).toLocaleString()} Ã— ${inputs.avs_clusters * inputs.avs_nodes} = Â£${(nodeCosts[inputs.avs_node_type][inputs.reserved_term] * inputs.avs_nodes * inputs.avs_clusters).toLocaleString()}</div>
            `;
            
            if (inputs.hybrid_benefit === 'yes') {
                detailsHtml += `
                    <div class="calculation-step">Azure Hybrid Benefit (40% discount) = Â£${(nodeCosts[inputs.avs_node_type][inputs.reserved_term] * inputs.avs_nodes * inputs.avs_clusters * 0.4).toLocaleString()} savings</div>
                `;
            }
            
            detailsHtml += `
                    <div class="calculation-step">Additional Azure Services = Â£${(inputs.expressroute + inputs.azure_backup + inputs.data_transfer + inputs.monitoring + inputs.additional_storage + inputs.security_services).toLocaleString()} per month</div>
                    <div class="calculation-result">Total Monthly Azure Cost = Â£${monthlyAzureCosts.toLocaleString()}</div>
                    <div class="calculation-result">Total Annual Azure Cost = Â£${annualAzureCosts.toLocaleString()}</div>
                </div>
            `;

                         // Migration investment section
             detailsHtml += `
                 <div class="calculation-section">
                     <h4>3. Migration Investment Calculation</h4>
                     <div class="calculation-step">Assessment & Planning = Â£${inputs.assessment.toLocaleString()}</div>
                     <div class="calculation-step">Professional Services = Â£${inputs.professional_services.toLocaleString()}</div>
                     <div class="calculation-step">Service Transition = Â£${inputs.service_transition.toLocaleString()}</div>
                     <div class="calculation-step">Base Migration Costs = Â£${migrationCosts.toLocaleString()}</div>
                     <div class="calculation-step">Contingency (${inputs.contingency}%) = Â£${(migrationCosts * inputs.contingency / 100).toLocaleString()}</div>
                     <div class="calculation-step">Modernisation Investment = Â£${inputs.modernisation_investment.toLocaleString()}</div>
                     <div class="calculation-step">Gross Investment = Â£${grossMigrationCosts.toLocaleString()}</div>
                     <div class="calculation-step">Microsoft Partner Migration Funding = Â£${inputs.migration_funding.toLocaleString()}</div>
                     <div class="calculation-step">Azure Consumption Credits = Â£${inputs.azure_credits.toLocaleString()}</div>
                     <div class="calculation-step">Additional Partner Incentives = Â£${inputs.additional_incentives.toLocaleString()}</div>
                     <div class="calculation-step">Total Partner Funding = Â£${totalPartnerFunding.toLocaleString()}</div>
                     <div class="calculation-result">Net Migration Investment = Â£${totalMigrationCosts.toLocaleString()}</div>
                 </div>
             `;

            // License renewal section
            detailsHtml += `
                <div class="calculation-section">
                    <h4>4. License Renewal Timing</h4>
                    <div class="calculation-step">VMware License Renewal Date = ${inputs.license_renewal_date}</div>
                    <div class="calculation-step">Current License Cost = Â£${inputs.current_vmware_cost.toLocaleString()}/year</div>
                    <div class="calculation-step">Expected New License Cost = Â£${inputs.new_vmware_cost.toLocaleString()}/year</div>
                    <div class="calculation-step">Migration Timeline = ${inputs.migration_timeline} months</div>
                    <div class="calculation-formula">All costs remain constant each year for simplified comparison</div>
                </div>
            `;

            // VMware License Calculation Details
            const vmwareRenewalDate = new Date(inputs.license_renewal_date);
            let vmwareMigrationStartDate, vmwareMigrationCompletionDate;
            
            if (inputs.migration_start_date) {
                vmwareMigrationStartDate = new Date(inputs.migration_start_date);
                vmwareMigrationCompletionDate = new Date(inputs.migration_start_date);
                vmwareMigrationCompletionDate.setMonth(vmwareMigrationCompletionDate.getMonth() + inputs.migration_timeline);
            } else {
                vmwareMigrationStartDate = new Date();
                vmwareMigrationCompletionDate = new Date();
                vmwareMigrationCompletionDate.setMonth(vmwareMigrationCompletionDate.getMonth() + inputs.migration_timeline);
            }
            
            detailsHtml += `
                <div class="calculation-section">
                    <h4>4A. VMware License Cost Calculation Details</h4>
                    <div class="calculation-step">Current Date = ${new Date().toDateString()}</div>
                    <div class="calculation-step">Migration Start Date = ${vmwareMigrationStartDate.toDateString()}</div>
                    <div class="calculation-step">Migration Duration = ${inputs.migration_timeline} months</div>
                    <div class="calculation-step">Migration Completion Date = ${vmwareMigrationCompletionDate.toDateString()}</div>
                    <div class="calculation-step">License Renewal Date = ${vmwareRenewalDate.toDateString()}</div>
                    <div class="calculation-step">Current License Cost = Â£${inputs.current_vmware_cost.toLocaleString()}/year</div>
                    <div class="calculation-step">New License Cost (after renewal) = Â£${inputs.new_vmware_cost.toLocaleString()}/year</div>
                    <div class="calculation-step">License Cost Per Day (current) = Â£${inputs.current_vmware_cost.toLocaleString()} Ã· 365 = Â£${(inputs.current_vmware_cost / 365).toLocaleString(undefined, {maximumFractionDigits: 2})}</div>
                    <div class="calculation-step">License Cost Per Day (new) = Â£${inputs.new_vmware_cost.toLocaleString()} Ã· 365 = Â£${(inputs.new_vmware_cost / 365).toLocaleString(undefined, {maximumFractionDigits: 2})}</div>
                    
                    <div class="calculation-formula"><strong>Two Scenarios Calculated Each Year:</strong></div>
                    <div class="calculation-step">1. <strong>Actual License Cost:</strong> What you actually pay (considers migration timing)</div>
                    <div class="calculation-step">   â€¢ Migration completion determines when license obligations end</div>
                    <div class="calculation-step">   â€¢ If migration completes before year start: Â£0</div>
                    <div class="calculation-step">   â€¢ If migration completes during year: Prorated based on days</div>
                    <div class="calculation-step">   â€¢ Formula: (License Cost Per Day) Ã— (Days Before Migration Completes)</div>
                    
                    <div class="calculation-step">2. <strong>Would-Have-Paid Cost:</strong> What you'd pay if no migration (baseline)</div>
                    <div class="calculation-step">   â€¢ Always calculates full year cost (365 days)</div>
                    <div class="calculation-step">   â€¢ Uses appropriate license cost based on renewal date</div>
                    <div class="calculation-step">   â€¢ Before renewal: Â£${(inputs.current_vmware_cost / 365).toLocaleString(undefined, {maximumFractionDigits: 2})} Ã— 365 = Â£${inputs.current_vmware_cost.toLocaleString()}</div>
                    <div class="calculation-step">   â€¢ After renewal: Â£${(inputs.new_vmware_cost / 365).toLocaleString(undefined, {maximumFractionDigits: 2})} Ã— 365 = Â£${inputs.new_vmware_cost.toLocaleString()}</div>
                    
                    <div class="calculation-formula"><strong>VMware License Saved = Would-Have-Paid - Actual Cost</strong></div>
                    <div class="calculation-formula"><strong>This shows the license cost avoided by migrating to Azure</strong></div>
                </div>
            `;

            // ROI calculation section
            detailsHtml += `
                <div class="calculation-section">
                    <h4>5. ROI Calculation</h4>
                    <div class="calculation-step">Total Savings (${inputs.analysis_period} years) = Â£${totalBenefits.toLocaleString()}</div>
                    <div class="calculation-step">Net Investment = Â£${totalMigrationCosts.toLocaleString()}</div>
                    <div class="calculation-formula">ROI = (Total Savings - Net Investment) / Net Investment Ã— 100</div>
                    <div class="calculation-step">ROI = (Â£${totalBenefits.toLocaleString()} - Â£${totalMigrationCosts.toLocaleString()}) / Â£${totalMigrationCosts.toLocaleString()} Ã— 100</div>
                    <div class="calculation-result">ROI = ${roi.toFixed(1)}%</div>
                </div>
            `;

            // Payback calculation section
            detailsHtml += `
                <div class="calculation-section">
                    <h4>6. Payback Period Calculation</h4>
                    <div class="calculation-formula">Payback occurs when cumulative savings â‰¥ net investment</div>
                    <div class="calculation-step">Net Investment to Recover = Â£${totalMigrationCosts.toLocaleString()}</div>
            `;
            
            if (paybackPeriod !== -1) {
                detailsHtml += `
                    <div class="calculation-result">Payback Period = ${paybackPeriod.toFixed(1)} years</div>
                `;
            } else {
                detailsHtml += `
                    <div class="calculation-result">Payback Period = No payback within ${inputs.analysis_period} years</div>
                `;
            }
            
            detailsHtml += `</div>`;

            calculationDetails.innerHTML = detailsHtml;

            // Show results
            document.getElementById('roi-results').style.display = 'block';
            
            // Switch to results tab
            showTab('results');
            document.querySelector('.tab:nth-child(6)').classList.add('active');
        }

        function createYearDetailsHTML(year, inputs, index) {
            // Calculate VMware license costs for this year
            const currentDate = new Date();
            const renewalDate = new Date(inputs.license_renewal_date);
            
            // Calculate migration dates
            let migrationStartDate, migrationCompletionDate;
            if (inputs.migration_start_date) {
                migrationStartDate = new Date(inputs.migration_start_date);
                migrationCompletionDate = new Date(inputs.migration_start_date);
                migrationCompletionDate.setMonth(migrationCompletionDate.getMonth() + inputs.migration_timeline);
            } else {
                // Fallback to current behavior if no start date specified
                migrationStartDate = new Date(currentDate);
                migrationCompletionDate = new Date(currentDate);
                migrationCompletionDate.setMonth(migrationCompletionDate.getMonth() + inputs.migration_timeline);
            }
            
            // Calculate license commitment end date
            const licenseCommitmentEndDate = new Date(renewalDate);
            licenseCommitmentEndDate.setFullYear(licenseCommitmentEndDate.getFullYear() + inputs.license_commitment_years);
            
            // When can you actually stop paying VMware?
            const canStopPayingDate = new Date(Math.max(migrationCompletionDate.getTime(), licenseCommitmentEndDate.getTime()));
            
            // Use calendar years starting from current year for logical business analysis
            const yearStartDate = new Date(currentDate.getFullYear() + year.year - 1, 0, 1); // January 1st of the analysis year
            const yearEndDate = new Date(currentDate.getFullYear() + year.year, 0, 1); // January 1st of next year
            
            // Calculate total days in this year
            const totalDaysInYear = (yearEndDate - yearStartDate) / (1000 * 60 * 60 * 24);
            
            // Determine which license cost applies for "would have paid" scenario
            let wouldHaveBeenLicenseCost = inputs.current_vmware_cost;
            let licenseRenewalCalculation = '';
            
            if (renewalDate <= yearStartDate) {
                wouldHaveBeenLicenseCost = inputs.new_vmware_cost;
                licenseRenewalCalculation = `Renewal date (${renewalDate.toDateString()}) is before year start, using new license cost: Â£${inputs.new_vmware_cost.toLocaleString()}`;
            } else if (renewalDate > yearStartDate && renewalDate <= yearEndDate) {
                const daysOldPrice = (renewalDate - yearStartDate) / (1000 * 60 * 60 * 24);
                const daysNewPrice = totalDaysInYear - daysOldPrice;
                wouldHaveBeenLicenseCost = (inputs.current_vmware_cost * daysOldPrice + inputs.new_vmware_cost * daysNewPrice) / totalDaysInYear;
                licenseRenewalCalculation = `Renewal occurs during year on ${renewalDate.toDateString()}:
                â€¢ Days at old price (${daysOldPrice.toFixed(0)} days): Â£${inputs.current_vmware_cost.toLocaleString()} Ã— ${daysOldPrice.toFixed(0)}/365 = Â£${((inputs.current_vmware_cost * daysOldPrice) / totalDaysInYear).toLocaleString(undefined, {maximumFractionDigits: 0})}
                â€¢ Days at new price (${daysNewPrice.toFixed(0)} days): Â£${inputs.new_vmware_cost.toLocaleString()} Ã— ${daysNewPrice.toFixed(0)}/365 = Â£${((inputs.new_vmware_cost * daysNewPrice) / totalDaysInYear).toLocaleString(undefined, {maximumFractionDigits: 0})}
                â€¢ Weighted average: Â£${wouldHaveBeenLicenseCost.toLocaleString(undefined, {maximumFractionDigits: 0})}`;
            } else {
                licenseRenewalCalculation = `Renewal date (${renewalDate.toDateString()}) is after year end, using current license cost: Â£${inputs.current_vmware_cost.toLocaleString()}`;
            }
            
            // Calculate actual license cost (considering migration AND commitment period)
            let actualLicenseCost = 0;
            let actualLicenseCalculation = '';
            let licenseDaysUsed = 0;
            
            if (canStopPayingDate <= yearStartDate) {
                actualLicenseCalculation = `âœ… No VMware license costs this year!
                â€¢ Migration completed: ${migrationCompletionDate.toDateString()}
                â€¢ License commitment ends: ${licenseCommitmentEndDate.toDateString()}
                â€¢ Can stop paying from: ${canStopPayingDate.toDateString()}
                â€¢ Year starts: ${yearStartDate.toDateString()}
                
                Since both migration is complete AND license commitment has ended before this year, you pay Â£0.`;
            } else if (canStopPayingDate >= yearEndDate) {
                licenseDaysUsed = totalDaysInYear;
                actualLicenseCost = wouldHaveBeenLicenseCost;
                
                let reasonForFullPayment = '';
                if (migrationCompletionDate >= yearEndDate && licenseCommitmentEndDate >= yearEndDate) {
                    reasonForFullPayment = 'Both migration and license commitment extend beyond this year';
                } else if (migrationCompletionDate >= yearEndDate) {
                    reasonForFullPayment = 'Migration not yet complete';
                } else {
                    reasonForFullPayment = `License commitment extends to ${licenseCommitmentEndDate.toDateString()} (migration completed ${migrationCompletionDate.toDateString()})`;
                }
                
                actualLicenseCalculation = `âŒ Full year license cost applies (${reasonForFullPayment}):
                â€¢ Migration completion: ${migrationCompletionDate.toDateString()}
                â€¢ License commitment ends: ${licenseCommitmentEndDate.toDateString()}
                â€¢ Can stop paying from: ${canStopPayingDate.toDateString()}
                â€¢ License cost per day: Â£${wouldHaveBeenLicenseCost.toLocaleString()} Ã· 365 = Â£${(wouldHaveBeenLicenseCost / 365).toLocaleString(undefined, {maximumFractionDigits: 2})}
                â€¢ Days used: ${licenseDaysUsed.toFixed(0)} days (full year)
                â€¢ Total cost: Â£${(wouldHaveBeenLicenseCost / 365).toLocaleString(undefined, {maximumFractionDigits: 2})} Ã— ${licenseDaysUsed.toFixed(0)} = Â£${actualLicenseCost.toLocaleString(undefined, {maximumFractionDigits: 0})}`;
            } else {
                licenseDaysUsed = (canStopPayingDate - yearStartDate) / (1000 * 60 * 60 * 24);
                actualLicenseCost = (wouldHaveBeenLicenseCost * licenseDaysUsed) / totalDaysInYear;
                
                let paymentReason = '';
                if (migrationCompletionDate < canStopPayingDate) {
                    paymentReason = `âš ï¸ Migration completes ${migrationCompletionDate.toDateString()} but you're locked into license commitment until ${licenseCommitmentEndDate.toDateString()}`;
                } else {
                    paymentReason = `âš ï¸ License commitment ends ${licenseCommitmentEndDate.toDateString()} but migration doesn't complete until ${migrationCompletionDate.toDateString()}`;
                }
                
                actualLicenseCalculation = `âš ï¸ Partial year license cost (${paymentReason}):
                
                ðŸ“‹ Key Dates:
                â€¢ Migration start: ${migrationStartDate.toDateString()}
                â€¢ Migration completion: ${migrationCompletionDate.toDateString()}
                â€¢ License renewal: ${renewalDate.toDateString()} (${inputs.license_commitment_years}-year commitment)
                â€¢ License commitment ends: ${licenseCommitmentEndDate.toDateString()}
                â€¢ Can stop paying from: ${canStopPayingDate.toDateString()}
                
                ðŸ’° Cost Calculation:
                â€¢ Year period: ${yearStartDate.toDateString()} to ${new Date(yearEndDate.getTime() - 24*60*60*1000).toDateString()}
                â€¢ Days with VMware license: ${licenseDaysUsed.toFixed(0)} days (until you can stop paying)
                â€¢ License cost per day: Â£${wouldHaveBeenLicenseCost.toLocaleString()} Ã· 365 = Â£${(wouldHaveBeenLicenseCost / 365).toLocaleString(undefined, {maximumFractionDigits: 2})}
                â€¢ Prorated cost: Â£${(wouldHaveBeenLicenseCost / 365).toLocaleString(undefined, {maximumFractionDigits: 2})} Ã— ${licenseDaysUsed.toFixed(0)} = Â£${actualLicenseCost.toLocaleString(undefined, {maximumFractionDigits: 0})}`;
            }
            
            const licenseDaysSaved = totalDaysInYear - licenseDaysUsed;
            const licenseCostSaved = wouldHaveBeenLicenseCost - actualLicenseCost;
            
            // Calculate Azure cost breakdown
            const avsNodeCostAnnual = calculateAVSNodeCost(inputs);
            const additionalServicesAnnual = (inputs.expressroute + inputs.azure_backup + inputs.data_transfer + inputs.monitoring + inputs.additional_storage + inputs.security_services) * 12;
            
            // Calculate hardware refresh details if applicable
            let hardwareRefreshDetails = '';
            if (year.refreshCost > 0) {
                const refreshPercentageDecimal = inputs.refresh_percentage / 100;
                hardwareRefreshDetails = `
                    <strong>ðŸ”§ Hardware Refresh Calculation:</strong>
                    <div class="calculation-detail">Hardware base cost: Â£${inputs.fixed_annual_cost.toLocaleString()}</div>
                    <div class="calculation-detail">Refresh percentage: ${inputs.refresh_percentage}% = ${refreshPercentageDecimal}</div>
                    <div class="calculation-detail">Cost multiplier: ${inputs.refresh_cost_multiplier} (${((inputs.refresh_cost_multiplier - 1) * 100).toFixed(0)}% increase)</div>
                    <div class="calculation-detail">Refresh cost calculation: Â£${inputs.fixed_annual_cost.toLocaleString()} Ã— ${refreshPercentageDecimal} Ã— ${inputs.refresh_cost_multiplier} = Â£${year.refreshCost.toLocaleString()}</div>
                    <br>`;
            }

            return `
                <div class="year-details" id="year-details-${index}">
                    <h5>Year ${year.year} Complete Calculation Breakdown</h5>
                    
                    <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 5px;">
                        <strong>ðŸ“… Migration Timeline Details:</strong>
                        <div class="calculation-detail">Migration start date: ${migrationStartDate.toDateString()}</div>
                        <div class="calculation-detail">Migration duration: ${inputs.migration_timeline} months</div>
                        <div class="calculation-detail">Migration completion: ${migrationCompletionDate.toDateString()}</div>
                        <div class="calculation-detail"><strong>Analysis Year ${year.year} (${currentDate.getFullYear() + year.year - 1}):</strong> ${yearStartDate.toDateString()} to ${new Date(yearEndDate.getTime() - 24*60*60*1000).toDateString()}</div>
                        <div class="calculation-detail">Period: ${yearStartDate.toLocaleDateString('en-US', {month: 'long'})} ${yearStartDate.getFullYear()} - ${new Date(yearEndDate.getTime() - 24*60*60*1000).toLocaleDateString('en-US', {month: 'long'})} ${new Date(yearEndDate.getTime() - 24*60*60*1000).getFullYear()}</div>
                        <div class="calculation-detail">Total days in analysis year: ${totalDaysInYear.toFixed(0)} days</div>
                        ${canStopPayingDate <= yearStartDate ? 
                            '<div class="calculation-detail" style="color: #28a745; font-weight: bold;">âœ… Both migration complete AND license commitment ended - NO VMware costs!</div>' : 
                            canStopPayingDate < yearEndDate ? 
                                '<div class="calculation-detail" style="color: #ff8c00; font-weight: bold;">âš ï¸ Can stop paying VMware during this year - Prorated costs</div>' :
                                migrationCompletionDate < yearEndDate && licenseCommitmentEndDate > yearEndDate ?
                                '<div class="calculation-detail" style="color: #dc3545; font-weight: bold;">âŒ Migration completes but still locked into license commitment - Full costs</div>' :
                                '<div class="calculation-detail" style="color: #dc3545; font-weight: bold;">âŒ Migration not complete OR license commitment active - Full VMware costs</div>'
                        }
                    </div>
                    
                    <div style="margin-bottom: 20px; padding: 15px; background: #fff3cd; border-radius: 5px;">
                        <strong>ðŸ’° VMware License "Would Have Paid" Calculation:</strong>
                        <div class="calculation-detail" style="white-space: pre-line;">${licenseRenewalCalculation}</div>
                        <div class="calculation-detail formula">Would have paid for full year: Â£${wouldHaveBeenLicenseCost.toLocaleString(undefined, {maximumFractionDigits: 0})}</div>
                    </div>
                    
                    <div style="margin-bottom: 20px; padding: 15px; background: #d4edda; border-radius: 5px;">
                        <strong>ðŸ’° VMware License "Actually Paid" Calculation:</strong>
                        <div class="calculation-detail" style="white-space: pre-line;">${actualLicenseCalculation}</div>
                        <div class="calculation-detail formula">Actually paid: Â£${actualLicenseCost.toLocaleString(undefined, {maximumFractionDigits: 0})}</div>
                        <div class="calculation-detail result">License days saved: ${licenseDaysSaved.toFixed(0)} days</div>
                        <div class="calculation-detail result">License cost saved: Â£${licenseCostSaved.toLocaleString(undefined, {maximumFractionDigits: 0})}</div>
                    </div>
                    
                    ${hardwareRefreshDetails}
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div style="padding: 15px; background: #e3f2fd; border-radius: 5px;">
                            <strong>ðŸ“Š On-Premises Costs Breakdown:</strong>
                            <div class="calculation-detail">Base annual hardware cost: Â£${inputs.fixed_annual_cost.toLocaleString()}</div>
                            <div class="calculation-detail">VMware license (actual): Â£${actualLicenseCost.toLocaleString(undefined, {maximumFractionDigits: 0})}</div>
                            ${year.refreshCost > 0 ? `<div class="calculation-detail">Hardware refresh: Â£${year.refreshCost.toLocaleString()}</div>` : ''}
                            <div class="calculation-detail formula">Total On-Premises = Â£${inputs.fixed_annual_cost.toLocaleString()} + Â£${actualLicenseCost.toLocaleString(undefined, {maximumFractionDigits: 0})} ${year.refreshCost > 0 ? `+ Â£${year.refreshCost.toLocaleString()}` : ''} = Â£${year.onPremCost.toLocaleString(undefined, {maximumFractionDigits: 0})}</div>
                        </div>
                        
                        <div style="padding: 15px; background: #e8f5e8; border-radius: 5px;">
                            <strong>â˜ï¸ Azure Costs Breakdown:</strong>
                            <div class="calculation-detail">AVS clusters: ${inputs.avs_clusters} Ã— ${inputs.avs_nodes} nodes (${inputs.avs_node_type}) = ${inputs.avs_clusters * inputs.avs_nodes} total nodes: Â£${avsNodeCostAnnual.toLocaleString()}</div>
                            <div class="calculation-detail">  â€¢ Node cost calculation details:</div>
                            <div class="calculation-detail">    - Base monthly cost per node: Â£${nodeCosts[inputs.avs_node_type][inputs.reserved_term].toLocaleString()}</div>
                            <div class="calculation-detail">    - Total monthly cost all clusters: Â£${calculateAVSNodeMonthlyCost(inputs).toLocaleString()}</div>
                            <div class="calculation-detail">    - Reserved term discount: ${inputs.reserved_term}</div>
                            ${inputs.hybrid_benefit === 'yes' ? `<div class="calculation-detail">    - Azure Hybrid Benefit: 40% savings applied</div>` : ''}
                            <div class="calculation-detail">    - Annual cost: Â£${calculateAVSNodeMonthlyCost(inputs).toLocaleString()} Ã— ${inputs.avs_nodes} Ã— 12 = Â£${avsNodeCostAnnual.toLocaleString()}</div>
                            <div class="calculation-detail">Additional services breakdown:</div>
                            <div class="calculation-detail">  â€¢ ExpressRoute: Â£${inputs.expressroute.toLocaleString()} Ã— 12 = Â£${(inputs.expressroute * 12).toLocaleString()}</div>
                            <div class="calculation-detail">  â€¢ Backup: Â£${inputs.azure_backup.toLocaleString()} Ã— 12 = Â£${(inputs.azure_backup * 12).toLocaleString()}</div>
                            <div class="calculation-detail">  â€¢ Data transfer: Â£${inputs.data_transfer.toLocaleString()} Ã— 12 = Â£${(inputs.data_transfer * 12).toLocaleString()}</div>
                            <div class="calculation-detail">  â€¢ Monitoring: Â£${inputs.monitoring.toLocaleString()} Ã— 12 = Â£${(inputs.monitoring * 12).toLocaleString()}</div>
                            <div class="calculation-detail">  â€¢ Additional storage: Â£${inputs.additional_storage.toLocaleString()} Ã— 12 = Â£${(inputs.additional_storage * 12).toLocaleString()}</div>
                            <div class="calculation-detail">  â€¢ Security: Â£${inputs.security_services.toLocaleString()} Ã— 12 = Â£${(inputs.security_services * 12).toLocaleString()}</div>
                            <div class="calculation-detail">Total additional services: Â£${additionalServicesAnnual.toLocaleString()}</div>
                            ${year.modernisationSavings !== 0 ? `<div class="calculation-detail">Modernisation impact: Â£${year.modernisationSavings.toLocaleString()}</div>` : ''}
                            <div class="calculation-detail formula">Total Azure = Â£${avsNodeCostAnnual.toLocaleString()} + Â£${additionalServicesAnnual.toLocaleString()} ${year.modernisationSavings !== 0 ? `+ Â£${year.modernisationSavings.toLocaleString()}` : ''} = Â£${year.azureCost.toLocaleString(undefined, {maximumFractionDigits: 0})}</div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; padding: 15px; background: #f0f8ff; border: 2px solid #0078d4; border-radius: 5px;">
                        <strong>ðŸ“ˆ Year ${year.year} Final Calculation:</strong>
                        <div class="calculation-detail">On-Premises total cost: Â£${year.onPremCost.toLocaleString(undefined, {maximumFractionDigits: 0})}</div>
                        <div class="calculation-detail">Azure total cost: Â£${year.azureCost.toLocaleString(undefined, {maximumFractionDigits: 0})}</div>
                        <div class="calculation-detail formula">Annual Savings = Â£${year.onPremCost.toLocaleString(undefined, {maximumFractionDigits: 0})} - Â£${year.azureCost.toLocaleString(undefined, {maximumFractionDigits: 0})} = Â£${year.savings.toLocaleString(undefined, {maximumFractionDigits: 0})}</div>
                        <div class="calculation-detail result">Cumulative Savings through Year ${year.year} = Â£${year.cumulative.toLocaleString(undefined, {maximumFractionDigits: 0})}</div>
                    </div>
                </div>
            `;
        }

        function calculateAVSNodeMonthlyCost(inputs) {
            const nodeCosts = {
                'AV36': { payg: 7000, '1year': 5600, '3year': 4200 },
                'AV36P': { payg: 9350, '1year': 7480, '3year': 5610 },
                'AV52': { payg: 14000, '1year': 11200, '3year': 8400 },
                'AV64': { payg: 11200, '1year': 8960, '3year': 6720 }
            };
            
            let monthlyAvsNodeCostPerNode = nodeCosts[inputs.avs_node_type][inputs.reserved_term];
            
            // Apply Azure Hybrid Benefit (approximately 40% savings on compute)
            if (inputs.hybrid_benefit === 'yes') {
                monthlyAvsNodeCostPerNode *= 0.6;
            }
            
            return monthlyAvsNodeCostPerNode * inputs.avs_nodes * (inputs.avs_clusters || 1);
        }

        function calculateAVSNodeCost(inputs) {
            return calculateAVSNodeMonthlyCost(inputs) * 12;
        }

        function toggleYearDetails(index) {
            const details = document.getElementById(`year-details-${index}`);
            const button = document.getElementById(`expand-btn-${index}`);
            
            if (details.classList.contains('show')) {
                details.classList.remove('show');
                button.textContent = 'ðŸ“Š Details';
            } else {
                details.classList.add('show');
                button.textContent = 'ðŸ“Š Hide';
            }
        }

        // Local Storage Functions to save/restore form data
        function calculateScenarios() {
            // Get all inputs from the form
            const costMethod = document.querySelector('input[name="cost_method"]:checked').value;
            const analysisYears = parseInt(document.getElementById('scenario_analysis_period').value) || 5;
            
            // Get all the inputs (reusing logic from calculateROI)
            const inputs = {
                cost_method: costMethod,
                fixed_annual_cost: parseFloat(document.getElementById('fixed_annual_cost').value) || 0,
                hardware_cost: parseFloat(document.getElementById('hardware_cost').value) || 0,
                vmware_licensing: parseFloat(document.getElementById('vmware_licensing').value) || 0,
                storage_hardware: parseFloat(document.getElementById('storage_hardware').value) || 0,
                network_equipment: parseFloat(document.getElementById('network_equipment').value) || 0,
                backup_hardware: parseFloat(document.getElementById('backup_hardware').value) || 0,
                support_contracts: parseFloat(document.getElementById('support_contracts').value) || 0,
                datacenter_space: parseFloat(document.getElementById('datacenter_space').value) || 0,
                power_cooling: parseFloat(document.getElementById('power_cooling').value) || 0,
                staff_costs: parseFloat(document.getElementById('staff_costs').value) || 0,
                connectivity: parseFloat(document.getElementById('connectivity').value) || 0,
                hardware_purchase_date: document.getElementById('hardware_purchase_date').value,
                refresh_cycle_years: parseInt(document.getElementById('refresh_cycle_years').value) || 4,
                refresh_cost_multiplier: parseFloat(document.getElementById('refresh_cost_multiplier').value) || 1.15,
                refresh_percentage: parseFloat(document.getElementById('refresh_percentage').value) || 85,
                hardware_end_of_support: document.getElementById('hardware_end_of_support').value,
                hardware_end_of_life: document.getElementById('hardware_end_of_life').value,
                avs_node_type: document.getElementById('avs_node_type').value,
                avs_clusters: parseInt(document.getElementById('avs_clusters').value) || 1,
                avs_nodes: parseInt(document.getElementById('avs_nodes').value) || 3,
                reserved_term: document.getElementById('reserved_term').value,
                hybrid_benefit: document.getElementById('hybrid_benefit').value,
                expressroute: parseFloat(document.getElementById('expressroute').value) || 0,
                azure_backup: parseFloat(document.getElementById('azure_backup').value) || 0,
                data_transfer: parseFloat(document.getElementById('data_transfer').value) || 0,
                monitoring: parseFloat(document.getElementById('monitoring').value) || 0,
                additional_storage: parseFloat(document.getElementById('additional_storage').value) || 0,
                security_services: parseFloat(document.getElementById('security_services').value) || 0,
                assessment: parseFloat(document.getElementById('assessment').value) || 0,
                professional_services: parseFloat(document.getElementById('professional_services').value) || 0,
                service_transition: parseFloat(document.getElementById('service_transition').value) || 0,
                contingency: parseFloat(document.getElementById('contingency').value) || 0,
                current_vmware_cost: parseFloat(document.getElementById('current_vmware_cost').value) || 0,
                license_renewal_date: document.getElementById('license_renewal_date').value,
                new_vmware_cost: parseFloat(document.getElementById('new_vmware_cost').value) || 0,
                license_commitment_years: parseInt(document.getElementById('license_commitment_years').value) || 1,
                migration_funding: parseFloat(document.getElementById('migration_funding').value) || 0,
                azure_credits: parseFloat(document.getElementById('azure_credits').value) || 0,
                additional_incentives: parseFloat(document.getElementById('additional_incentives').value) || 0,
                migration_timeline: parseInt(document.getElementById('migration_timeline').value) || 6,
                migration_start_date: document.getElementById('migration_start_date').value
            };

            // Calculate base annual costs
            let baseAnnualOnPremCosts;
            let hardwareRelatedCosts;
            
            if (inputs.cost_method === 'fixed') {
                baseAnnualOnPremCosts = inputs.fixed_annual_cost;
                hardwareRelatedCosts = inputs.fixed_annual_cost;
            } else {
                baseAnnualOnPremCosts = inputs.hardware_cost + inputs.vmware_licensing + 
                    inputs.storage_hardware + inputs.network_equipment + inputs.backup_hardware + 
                    inputs.support_contracts + inputs.datacenter_space + inputs.power_cooling + 
                    inputs.staff_costs + inputs.connectivity;
                hardwareRelatedCosts = inputs.hardware_cost + inputs.storage_hardware + inputs.network_equipment;
            }

            // Calculate when hardware refresh is needed
            const purchaseDate = new Date(inputs.hardware_purchase_date);
            const currentDate = new Date();
            const endOfSupportDate = new Date(inputs.hardware_end_of_support);
            const endOfLifeDate = new Date(inputs.hardware_end_of_life);
            
            // Determine refresh timing (prefer end of support as trigger)
            let refreshTriggerDate = endOfSupportDate;
            if (!inputs.hardware_end_of_support && inputs.hardware_end_of_life) {
                refreshTriggerDate = endOfLifeDate;
            }
            
            const refreshTriggerYear = refreshTriggerDate.getFullYear();
            const refreshCost = hardwareRelatedCosts * inputs.refresh_cost_multiplier * (inputs.refresh_percentage / 100);

            // Calculate Azure costs
            const nodeCosts = {
                'AV36': { payg: 7000, '1year': 5600, '3year': 4200 },
                'AV36P': { payg: 9350, '1year': 7480, '3year': 5610 },
                'AV52': { payg: 14000, '1year': 11200, '3year': 8400 },
                'AV64': { payg: 11200, '1year': 8960, '3year': 6720 }
            };

            let monthlyAvsNodeCost = nodeCosts[inputs.avs_node_type][inputs.reserved_term] * inputs.avs_nodes * inputs.avs_clusters;
            if (inputs.hybrid_benefit === 'yes') {
                monthlyAvsNodeCost *= 0.6;
            }

            const monthlyAzureCosts = monthlyAvsNodeCost + inputs.expressroute + inputs.azure_backup + 
                inputs.data_transfer + inputs.monitoring + inputs.additional_storage + inputs.security_services;
            const annualAzureCosts = monthlyAzureCosts * 12;

            // Calculate migration investment
            const migrationCosts = inputs.assessment + inputs.professional_services + inputs.service_transition;
            const grossMigrationCosts = migrationCosts * (1 + inputs.contingency / 100);
            const totalPartnerFunding = inputs.migration_funding + inputs.azure_credits + inputs.additional_incentives;
            const netMigrationCosts = Math.max(0, grossMigrationCosts - totalPartnerFunding);

            // Calculate scenarios year by year
            const scenarioA = []; // Do Nothing
            const scenarioB = []; // Migrate
            let cumulativeDifference = 0;
            let breakEvenYear = 0;

            for (let year = 1; year <= analysisYears; year++) {
                const currentYear = currentDate.getFullYear() + year - 1;
                
                // Scenario A: Do Nothing costs
                let yearAcosts = baseAnnualOnPremCosts;
                
                // Add VMware license costs (may increase after renewal)
                const renewalDate = new Date(inputs.license_renewal_date);
                let vmwareCost = inputs.current_vmware_cost;
                if (currentYear >= renewalDate.getFullYear()) {
                    vmwareCost = inputs.new_vmware_cost;
                }
                yearAcosts += vmwareCost;
                
                // Add hardware refresh cost if needed
                let refreshCostThisYear = 0;
                if (currentYear === refreshTriggerYear) {
                    refreshCostThisYear = refreshCost;
                    yearAcosts += refreshCostThisYear;
                }
                
                scenarioA.push({
                    year: year,
                    costs: yearAcosts,
                    events: [
                        `Annual operations: Â£${baseAnnualOnPremCosts.toLocaleString()}`,
                        `VMware licensing: Â£${vmwareCost.toLocaleString()}`,
                        ...(refreshCostThisYear > 0 ? [`Hardware refresh: Â£${refreshCostThisYear.toLocaleString()}`] : [])
                    ]
                });

                // Scenario B: Migration costs
                let yearBcosts = annualAzureCosts;
                
                // Add migration investment in year 1
                let migrationCostThisYear = 0;
                if (year === 1) {
                    migrationCostThisYear = netMigrationCosts;
                    yearBcosts += migrationCostThisYear;
                }
                
                scenarioB.push({
                    year: year,
                    costs: yearBcosts,
                    events: [
                        `Azure VMware Solution: Â£${annualAzureCosts.toLocaleString()}`,
                        ...(migrationCostThisYear > 0 ? [`Migration investment: Â£${migrationCostThisYear.toLocaleString()}`] : [])
                    ]
                });

                // Calculate cumulative difference
                const yearlyDifference = yearAcosts - yearBcosts;
                cumulativeDifference += yearlyDifference;
                
                // Check for break-even point
                if (cumulativeDifference >= 0 && breakEvenYear === 0) {
                    breakEvenYear = year;
                }
            }

            // Calculate totals
            const totalScenarioA = scenarioA.reduce((sum, year) => sum + year.costs, 0);
            const totalScenarioB = scenarioB.reduce((sum, year) => sum + year.costs, 0);
            const totalDifference = totalScenarioA - totalScenarioB;

            // Determine recommendation
            let recommendation = "Calculate scenarios to see recommendation";
            if (totalScenarioB < totalScenarioA) {
                recommendation = `Migrate to Azure VMware Solution (Save Â£${totalDifference.toLocaleString()})`;
            } else {
                recommendation = `Stay On-Premises (Save Â£${Math.abs(totalDifference).toLocaleString()})`;
            }

            // Update UI
            document.getElementById('recommended-strategy').textContent = recommendation;
            document.getElementById('recommended-strategy').className = totalScenarioB < totalScenarioA ? 'metric-value positive' : 'metric-value negative';
            
            document.getElementById('scenario-cost-difference').textContent = `Â£${Math.abs(totalDifference).toLocaleString()}`;
            document.getElementById('scenario-cost-difference').className = totalScenarioB < totalScenarioA ? 'metric-value positive' : 'metric-value negative';
            
            document.getElementById('scenario-breakeven').textContent = breakEvenYear > 0 ? `Year ${breakEvenYear}` : 'No break-even in analysis period';
            
            document.getElementById('scenario-a-total').textContent = `Â£${totalScenarioA.toLocaleString()}`;
            document.getElementById('scenario-b-total').textContent = `Â£${totalScenarioB.toLocaleString()}`;

            // Populate events
            document.getElementById('scenario-a-events').innerHTML = scenarioA
                .filter(year => year.events.length > 1 || year.events[0].includes('refresh'))
                .map(year => `<div><strong>Year ${year.year}:</strong><br/>${year.events.join('<br/>')}</div>`)
                .join('<br/>');

            document.getElementById('scenario-b-events').innerHTML = scenarioB
                .filter(year => year.events.length > 1)
                .map(year => `<div><strong>Year ${year.year}:</strong><br/>${year.events.join('<br/>')}</div>`)
                .join('<br/>');

            // Populate yearly breakdown table
            const yearlyBreakdown = document.getElementById('scenario-yearly-breakdown');
            yearlyBreakdown.innerHTML = '';
            
            let runningCumulative = 0;
            for (let i = 0; i < analysisYears; i++) {
                const yearDiff = scenarioA[i].costs - scenarioB[i].costs;
                runningCumulative += yearDiff;
                
                const row = document.createElement('tr');
                if (i + 1 === breakEvenYear) {
                    row.style.backgroundColor = '#d4edda';
                    row.style.fontWeight = 'bold';
                }
                
                row.innerHTML = `
                    <td>Year ${i + 1}</td>
                    <td>Â£${scenarioA[i].costs.toLocaleString()}</td>
                    <td>Â£${scenarioB[i].costs.toLocaleString()}</td>
                    <td style="color: ${yearDiff > 0 ? '#28a745' : '#dc3545'}">Â£${yearDiff.toLocaleString()}</td>
                    <td style="color: ${runningCumulative > 0 ? '#28a745' : '#dc3545'}">Â£${runningCumulative.toLocaleString()}</td>
                    <td>${runningCumulative >= 0 ? 'âœ… Migration pays for itself' : 'â³ Still recovering investment'}</td>
                `;
                yearlyBreakdown.appendChild(row);
            }

            // Update decision matrix
            document.getElementById('decision-cost-do-nothing').textContent = `Â£${totalScenarioA.toLocaleString()}`;
            document.getElementById('decision-cost-migrate').textContent = `Â£${totalScenarioB.toLocaleString()}`;
            document.getElementById('decision-cost-winner').innerHTML = totalScenarioB < totalScenarioA ? 
                '<span style="color: #28a745;">âœ… Migrate</span>' : 
                '<span style="color: #dc3545;">âŒ Do Nothing</span>';

            // Show results
            document.getElementById('scenario-results').style.display = 'block';
        }

        function saveFormData() {
            const formData = {};
            
            // Get all input fields
            const inputs = document.querySelectorAll('input[type="number"], input[type="date"], input[type="radio"]:checked, select');
            inputs.forEach(input => {
                if (input.type === 'radio') {
                    if (input.checked) {
                        formData[input.name] = input.value;
                    }
                } else {
                    formData[input.id] = input.value;
                }
            });
            
            // Save to localStorage
            localStorage.setItem('avsCalculatorData', JSON.stringify(formData));
            
            // Brief visual feedback that data was saved
            const indicator = document.querySelector('span[style*="ðŸ’¾"]');
            if (indicator) {
                indicator.style.opacity = '1';
                indicator.style.fontWeight = 'bold';
                setTimeout(() => {
                    indicator.style.opacity = '0.7';
                    indicator.style.fontWeight = 'normal';
                }, 800);
            }
        }

        function restoreFormData() {
            const savedData = localStorage.getItem('avsCalculatorData');
            if (!savedData) return;
            
            try {
                const formData = JSON.parse(savedData);
                
                // Restore all input fields
                Object.keys(formData).forEach(key => {
                    const element = document.getElementById(key) || document.querySelector(`input[name="${key}"][value="${formData[key]}"]`);
                    if (element) {
                        if (element.type === 'radio') {
                            element.checked = true;
                            // Trigger change event for radio buttons
                            element.dispatchEvent(new Event('change'));
                        } else {
                            element.value = formData[key];
                        }
                    }
                });
                
                // Update cost method display
                toggleCostMethod();
                // Update refresh schedule
                updateRefreshSchedule();
                // Update migration schedule
                updateMigrationSchedule();
                
                // Show brief indication that data was restored
                setTimeout(() => {
                    const indicator = document.querySelector('span[style*="ðŸ’¾"]');
                    if (indicator) {
                        const originalText = indicator.textContent;
                        indicator.textContent = 'ðŸ“¥ Previous data restored';
                        indicator.style.opacity = '1';
                        indicator.style.fontWeight = 'bold';
                        setTimeout(() => {
                            indicator.textContent = originalText;
                            indicator.style.opacity = '0.7';
                            indicator.style.fontWeight = 'normal';
                        }, 2000);
                    }
                }, 500);
                
            } catch (error) {
                console.log('Error restoring form data:', error);
            }
        }

        function clearFormData() {
            localStorage.removeItem('avsCalculatorData');
        }

        // Auto-save form data when inputs change
        function setupAutoSave() {
            const inputs = document.querySelectorAll('input, select');
            inputs.forEach(input => {
                input.addEventListener('input', saveFormData);
                input.addEventListener('change', saveFormData);
            });
        }

        // Initialize page with saved data
        document.addEventListener('DOMContentLoaded', function() {
            restoreFormData();
            setupAutoSave();
            updateRefreshSchedule();
            
            // Add clear data button (optional)
            const clearButton = document.createElement('button');
            clearButton.textContent = 'Clear Saved Data';
            clearButton.style.cssText = 'background: #dc3545; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; margin-left: 20px; font-size: 14px;';
            clearButton.onclick = function() {
                if (confirm('Clear all saved form data? This will permanently remove your saved inputs from this browser.')) {
                    clearFormData();
                    location.reload();
                }
            };
            
            // Add auto-save indicator
            const autoSaveIndicator = document.createElement('span');
            autoSaveIndicator.textContent = 'ðŸ’¾ Data auto-saved';
            autoSaveIndicator.style.cssText = 'color: #28a745; font-size: 12px; margin-left: 15px; opacity: 0.7;';
            
            // Add to header
            const header = document.querySelector('.header');
            const buttonContainer = document.createElement('div');
            buttonContainer.style.cssText = 'margin-top: 10px; text-align: center;';
            buttonContainer.appendChild(clearButton);
            buttonContainer.appendChild(autoSaveIndicator);
            header.appendChild(buttonContainer);
        });
    </script>
</body>
</html>